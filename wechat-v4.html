<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é»‘é˜¿çŒ« - å¾®ä¿¡å…¬ä¼—å·åˆ›ä½œå·¥ä½œæµå·¥å…· (V3 å¤šæ–‡ç« ç”Ÿæˆç‰ˆ)</title>
    <!-- Tesseract.js OCRåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        /* ==================== å…¨å±€æ ·å¼é‡ç½® ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* ==================== CSSå˜é‡å®šä¹‰ ==================== */
        :root {
            --primary-color: #1890ff;
            --success-color: #52c41a;
            --warning-color: #faad14;
            --processing-color: #1890ff;
            --error-color: #f5222d;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-primary: #262626;
            --text-secondary: #8c8c8c;
            --border-color: #d9d9d9;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
        }

        /* ==================== åŸºç¡€é¡µé¢æ ·å¼ ==================== */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
            background: var(--bg-color);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        /* ==================== å®¹å™¨å¸ƒå±€ ==================== */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        /* ==================== é¡µé¢å¤´éƒ¨ ==================== */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1em;
            opacity: 0.9;
        }

        .header .badge {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            margin-top: 10px;
        }

        /* ==================== ä¸»è¦å†…å®¹åŒºåŸŸ ==================== */
        .main-content {
            padding: 30px;
        }

        /* ==================== é€‰é¡¹å¡æ ·å¼ ==================== */
        .tabs {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 500;
            color: var(--text-secondary);
            position: relative;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .tab:hover {
            color: var(--primary-color);
        }

        .tab.active {
            color: var(--primary-color);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ==================== å¡ç‰‡é€šç”¨æ ·å¼ ==================== */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
        }

        /* ==================== è¡¨å•æ ·å¼ ==================== */
        .form-section {
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .form-group label .required {
            color: var(--error-color);
            margin-left: 4px;
        }

        .form-group input[type="text"],
        .form-group input[type="password"],
        .form-group input[type="number"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            transition: all 0.3s;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-group .hint {
            font-size: 0.85em;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }

        /* ==================== å¿«æ·å¡«å……æŒ‰é’® ==================== */
        .quick-fill {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .quick-fill-btn {
            padding: 6px 12px;
            background: #f5f5f5;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-fill-btn:hover {
            background: #e6f7ff;
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        /* ==================== æŒ‰é’®æ ·å¼ ==================== */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            min-height: 44px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: #40a9ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(24, 144, 255, 0.3);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background: #49ad16;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* ==================== è¿›åº¦æ¡åŒºåŸŸ ==================== */
        .progress-section {
            margin: 30px 0;
            padding: 20px;
            background: #fafafa;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }

        .progress-title {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            text-align: center;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            margin-bottom: 20px;
            padding: 0 10px;
        }

        /* è¿›åº¦æ¡è¿æ¥çº¿ */
        .progress-steps::before {
            content: '';
            position: absolute;
            top: 30px;
            left: 60px;
            right: 60px;
            height: 3px;
            background: linear-gradient(to right,
                var(--border-color) 0%,
                var(--border-color) 100%);
            z-index: 0;
            border-radius: 2px;
        }

        /* åŠ¨æ€è¿›åº¦æ¡ï¼ˆæ ¹æ®å®ŒæˆçŠ¶æ€æ”¹å˜é¢œè‰²ï¼‰ */
        .progress-steps.step-1-completed::before {
            background: linear-gradient(to right,
                var(--success-color) 0%,
                var(--success-color) 25%,
                var(--border-color) 25%,
                var(--border-color) 100%);
        }

        .progress-steps.step-2-completed::before {
            background: linear-gradient(to right,
                var(--success-color) 0%,
                var(--success-color) 50%,
                var(--border-color) 50%,
                var(--border-color) 100%);
        }

        .progress-steps.step-3-completed::before {
            background: linear-gradient(to right,
                var(--success-color) 0%,
                var(--success-color) 75%,
                var(--border-color) 75%,
                var(--border-color) 100%);
        }

        .progress-steps.step-4-completed::before {
            background: var(--success-color);
        }

        .step-item {
            position: relative;
            z-index: 1;
            text-align: center;
            flex: 1;
        }

        .step-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: white;
            border: 3px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            font-size: 1.4em;
            font-weight: 600;
            transition: all 0.4s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .step-label {
            font-size: 0.9em;
            color: var(--text-secondary);
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .step-status {
            font-size: 0.75em;
            margin-top: 4px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ==================== çŠ¶æ€é¢œè‰²å®šä¹‰ ==================== */
        /* å¾…æ‰§è¡Œ - é»„è‰² */
        .step-item.pending .step-icon {
            border-color: var(--warning-color);
            color: var(--warning-color);
            background: #fffbe6;
        }
        .step-item.pending .step-label {
            color: var(--warning-color);
        }
        .step-item.pending .step-status {
            color: var(--warning-color);
        }

        /* æ‰§è¡Œä¸­ - è“è‰² */
        .step-item.processing .step-icon {
            border-color: var(--processing-color);
            color: var(--processing-color);
            background: #e6f7ff;
            animation: pulse 1.5s infinite;
            box-shadow: 0 0 0 0 rgba(24, 144, 255, 0.4);
        }
        .step-item.processing .step-label {
            color: var(--processing-color);
            font-weight: 600;
        }
        .step-item.processing .step-status {
            color: var(--processing-color);
        }

        /* å®Œæˆ - ç»¿è‰² */
        .step-item.completed .step-icon {
            border-color: var(--success-color);
            background: var(--success-color);
            color: white;
            box-shadow: 0 4px 12px rgba(82, 196, 26, 0.3);
        }
        .step-item.completed .step-label {
            color: var(--success-color);
            font-weight: 600;
        }
        .step-item.completed .step-status {
            color: var(--success-color);
        }

        /* å¤±è´¥ - çº¢è‰² */
        .step-item.failed .step-icon {
            border-color: var(--error-color);
            background: #fff1f0;
            color: var(--error-color);
            box-shadow: 0 4px 12px rgba(245, 34, 45, 0.3);
        }
        .step-item.failed .step-label {
            color: var(--error-color);
            font-weight: 600;
        }
        .step-item.failed .step-status {
            color: var(--error-color);
        }

        /* ==================== åŠ¨ç”»æ•ˆæœ ==================== */
        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(24, 144, 255, 0.4);
            }
            50% {
                box-shadow: 0 0 0 15px rgba(24, 144, 255, 0);
            }
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        /* æ‰§è¡Œä¸­å›¾æ ‡æ—‹è½¬æ•ˆæœ */
        .step-item.processing .step-icon {
            animation: pulse 1.5s infinite, rotate 2s linear infinite;
        }

        /* å®ŒæˆçŠ¶æ€çš„å¯¹å‹¾åŠ¨ç”» */
        .step-item.completed .step-icon {
            animation: checkmark 0.4s ease-in-out;
        }

        @keyframes checkmark {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(1);
            }
        }

        /* ==================== ç»“æœå¡ç‰‡åŒºåŸŸ ==================== */
        .results-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .result-card {
            background: #fafafa;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            display: none;
        }

        .result-card.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .result-card-title {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--text-primary);
        }

        .result-content {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 15px;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.8;
            color: var(--text-primary);
        }

        .copy-btn {
            padding: 6px 16px;
            font-size: 0.9em;
            min-height: 32px;
        }

        /* ==================== åŠ è½½åŠ¨ç”» ==================== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            flex-direction: column;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.1em;
            color: var(--text-primary);
        }

        /* ==================== æç¤ºä¿¡æ¯ ==================== */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 12px 24px;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s;
            z-index: 2000;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast.error {
            background: var(--error-color);
        }

        /* ==================== å“åº”å¼è®¾è®¡ ==================== */
        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }

            .form-row, .form-row-3 {
                grid-template-columns: 1fr;
            }

            .progress-steps {
                flex-direction: column;
                gap: 20px;
            }

            .progress-steps::before {
                display: none;
            }

            .step-item {
                display: flex;
                align-items: center;
                gap: 15px;
                text-align: left;
            }

            .step-icon {
                margin: 0;
            }

            .results-section {
                grid-template-columns: 1fr;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .tabs {
                flex-direction: column;
            }
        }

        /* ==================== æ ‡é¢˜åˆ†ç±»æ ‡ç­¾ ==================== */
        .title-category {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .title-category.viral {
            background: #fff1f0;
            color: #f5222d;
            border: 1px solid #ffa39e;
        }

        .title-category.practical {
            background: #f6ffed;
            color: #52c41a;
            border: 1px solid #b7eb8f;
        }

        .title-item {
            padding: 10px;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .title-item:hover {
            border-color: var(--primary-color);
            background: #f0f8ff;
        }

        .title-item:last-child {
            margin-bottom: 0;
        }

        /* ==================== æ€»ç»“é¢„è§ˆåŒºåŸŸ ==================== */
        .summary-preview {
            background: #f0f8ff;
            border: 1px solid #b3d8ff;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
        }

        .summary-preview-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        /* ==================== APIé…ç½®åŒºåŸŸ ==================== */
        .api-config-section {
            background: #f8f9fa;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
        }

        .api-config-title {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .api-config-toggle {
            cursor: pointer;
            user-select: none;
        }

        .api-config-content {
            display: none;
        }

        .api-config-content.show {
            display: block;
        }

        /* ==================== è¯»è€…ç±»å‹è¯´æ˜å¡ç‰‡ ==================== */
        .reader-type-card {
            background: #f9f9f9;
            border-left: 4px solid var(--primary-color);
            padding: 12px 15px;
            margin-bottom: 15px;
            border-radius: 4px;
        }

        .reader-type-card h4 {
            color: var(--text-primary);
            margin-bottom: 5px;
            font-size: 1em;
        }

        .reader-type-card p {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin: 0;
        }

        .reader-type-card .role-tag {
            display: inline-block;
            background: var(--primary-color);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            margin-bottom: 5px;
        }

        /* ==================== å¤šæ–‡ç« æ ‡ç­¾é¡µ ==================== */
        .article-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .article-tab {
            padding: 8px 16px;
            background: #f0f0f0;
            border: none;
            border-radius: 4px 4px 0 0;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .article-tab.active {
            background: var(--primary-color);
            color: white;
        }

        .article-tab:hover:not(.active) {
            background: #e0e0e0;
        }

        /* ==================== OCRä¸Šä¼ åŒºåŸŸ ==================== */
        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius);
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #fafafa;
            position: relative;
            min-height: 200px;
        }

        .upload-area:hover {
            border-color: var(--primary-color);
            background: #f0f8ff;
        }

        .upload-area.dragover {
            border-color: var(--primary-color);
            background: #e6f7ff;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .upload-placeholder p {
            margin: 8px 0;
            color: var(--text-primary);
        }

        .file-list {
            margin-top: 20px;
            text-align: left;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }

        .file-item:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .file-item-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .file-item-icon {
            font-size: 24px;
        }

        .file-item-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .file-item-size {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .file-item-remove {
            padding: 6px 12px;
            background: #fff1f0;
            color: var(--error-color);
            border: 1px solid #ffa39e;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-item-remove:hover {
            background: var(--error-color);
            color: white;
        }

        /* ==================== OCRè¿›åº¦æ¡ ==================== */
        .ocr-progress {
            margin: 20px 0;
            padding: 20px;
            background: #f0f8ff;
            border-radius: var(--border-radius);
            border: 1px solid #b3d8ff;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e6f7ff;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--success-color));
            border-radius: 15px;
            transition: width 0.3s ease;
            width: 0%;
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent
            );
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }

        .progress-text {
            text-align: center;
            color: var(--text-primary);
            font-weight: 500;
            margin: 0;
        }

        /* ==================== OCRç»“æœ ==================== */
        .ocr-result {
            margin-top: 20px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }

        .ocr-result h3 {
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .ocr-result textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            background: white;
            color: var(--text-primary);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡µé¢å¤´éƒ¨ -->
        <div class="header">
            <h1>ğŸ± é»‘é˜¿çŒ«åˆ›ä½œåŠ©æ‰‹ V3</h1>
            <p>å¾®ä¿¡å…¬ä¼—å·å†…å®¹åˆ›ä½œå·¥ä½œæµå·¥å…· - å¤šæ–‡ç« ç”Ÿæˆç‰ˆ</p>
            <div class="badge">âœ¨ æ”¯æŒä¸€æ¬¡ç”Ÿæˆä¸¤ç¯‡æ–‡ç«  + è‡ªåŠ¨ç”Ÿæˆ5ä¸ªå…¬ä¼—å·æ ‡é¢˜</div>
        </div>

        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <div class="main-content">
            <!-- é€‰é¡¹å¡å¯¼èˆª -->
            <div class="tabs">
                <button class="tab active" data-tab="manual">ğŸ“ æ‰‹åŠ¨åˆ›ä½œ</button>
                <button class="tab" data-tab="paste">ğŸ“‹ æ–‡å­—ç²˜è´´</button>
                <button class="tab" data-tab="ocr">ğŸ“· å›¾ç‰‡/PDFè¯†åˆ«</button>
                <button class="tab" data-tab="url">ğŸ”— URLæŠ“å–</button>
                <button class="tab" data-tab="api">âš™ï¸ APIé…ç½®</button>
            </div>

            <!-- æ‰‹åŠ¨åˆ›ä½œé€‰é¡¹å¡ -->
            <div class="tab-content active" id="manualTab">
                <!-- å‚æ•°è¾“å…¥åŒºåŸŸ -->
                <div class="card form-section">
                    <h2 class="card-title">ğŸ“ åˆ›ä½œå‚æ•°é…ç½®</h2>

                    <form id="createForm">
                        <div class="form-group">
                            <label>ç›®æ ‡è¯»è€…<span class="required">*</span></label>
                            <select id="targetAudience" required>
                                <option value="">è¯·é€‰æ‹©...</option>
                                <option value="general">æ™®é€šå¤§ä¼— / åƒç“œç¾¤ä¼—</option>
                                <option value="creator">è‡ªåª’ä½“ / å†…å®¹åˆ›ä½œè€…</option>
                                <option value="business">äº§å“ / è¿è¥ / å•†ä¸šäºº</option>
                                <option value="tech">æŠ€æœ¯ä»ä¸šè€…</option>
                                <option value="emotional">æƒ…ç»ªå…±é¸£å‹è¯»è€…</option>
                            </select>
                            <div class="hint" id="audienceHint">é€‰æ‹©ç›®æ ‡è¯»è€…åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åŒ¹é…æœ€åˆé€‚çš„å†™ä½œé£æ ¼å’Œå™äº‹ç»“æ„</div>
                        </div>

                        <!-- è¯»è€…ç±»å‹è¯´æ˜ï¼ˆåŠ¨æ€æ˜¾ç¤ºï¼‰ -->
                        <div id="readerTypeExplanation"></div>

                        <div class="form-group">
                            <label>é€‰é¢˜ä¸»é¢˜<span class="required">*</span></label>
                            <input type="text" id="topic" placeholder="ä¾‹å¦‚ï¼šAIå¤§æ¨¡å‹çš„æŠ€æœ¯å‘å±•è¶‹åŠ¿ä¸åº”ç”¨å‰æ™¯" required>
                            <div class="hint">æ¸…æ™°æ˜ç¡®çš„æ–‡ç« ä¸»é¢˜</div>
                        </div>

                        <div class="form-group">
                            <label>æ ¸å¿ƒè§‚ç‚¹<span class="required">*</span></label>
                            <textarea id="coreView" rows="4" placeholder="ä¾‹å¦‚ï¼š&#10;1. AIå¤§æ¨¡å‹æ­£åœ¨ä»é€šç”¨å‹å‘å‚ç›´é¢†åŸŸæ·±åŒ–&#10;2. å¤šæ¨¡æ€èåˆæ˜¯ä¸‹ä¸€ä¸ªæŠ€æœ¯çªç ´å£&#10;3. å®é™…åº”ç”¨åœºæ™¯è½åœ°æ˜¯å…³é”®æŒ‘æˆ˜" required></textarea>
                            <div class="hint">åˆ—å‡º3-5ä¸ªæ ¸å¿ƒè§‚ç‚¹ï¼Œæ¯è¡Œä¸€ä¸ª</div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>å­—æ•°è¦æ±‚<span class="required">*</span></label>
                                <input type="number" id="wordCount" value="1500" min="500" max="5000" required>
                            </div>

                            <div class="form-group">
                                <label>å…³é”®è¯æ ‡ç­¾</label>
                                <input type="text" id="keywords" placeholder="ä¾‹å¦‚ï¼šAI, å¤§æ¨¡å‹, äººå·¥æ™ºèƒ½, ChatGPT">
                                <div class="hint">ç”¨é€—å·åˆ†éš”å¤šä¸ªå…³é”®è¯</div>
                            </div>
                        </div>

                        <div class="form-row-3">
                            <div class="form-group">
                                <label>é€‰æ‹©AIæ¨¡å‹</label>
                                <select id="aiModel">
                                    <option value="deepseek">DeepSeek</option>
                                    <option value="doubao">è±†åŒ…</option>
                                    <option value="kimi">Kimi</option>
                                    <option value="tongyi">é€šä¹‰åƒé—®</option>
                                    <option value="simulate">æ¨¡æ‹Ÿæ¨¡å¼ï¼ˆæ— APIï¼‰</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>åŸæ–‡è¯­è¨€</label>
                                <select id="sourceLanguage">
                                    <option value="zh">ä¸­æ–‡</option>
                                    <option value="en">è‹±æ–‡</option>
                                    <option value="auto">è‡ªåŠ¨æ£€æµ‹</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>ç”Ÿæˆæ•°é‡</label>
                                <select id="articleCount">
                                    <option value="1">ç”Ÿæˆ1ç¯‡æ–‡ç« </option>
                                    <option value="2" selected>ç”Ÿæˆ2ç¯‡æ–‡ç« </option>
                                </select>
                                <div class="hint">ä¸€æ¬¡ç”Ÿæˆå¤šç¯‡æ–‡ç« ï¼Œä¸°å¯Œå†…å®¹é€‰æ‹©</div>
                            </div>
                        </div>

                        <div class="btn-group">
                            <button type="button" class="btn btn-primary" id="startWorkflowBtn">
                                <span>ğŸš€</span> å¯åŠ¨åˆ›ä½œå·¥ä½œæµ
                            </button>
                            <button type="button" class="btn btn-secondary" id="clearBtn">
                                <span>ğŸ—‘ï¸</span> æ¸…ç©º
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- å›¾ç‰‡/PDFè¯†åˆ«é€‰é¡¹å¡ -->
            <div class="tab-content" id="ocrTab">
                <div class="card form-section">
                    <h2 class="card-title">ğŸ“· å›¾ç‰‡/PDFæ–‡å­—è¯†åˆ«</h2>

                    <div class="form-group">
                        <label>ä¸Šä¼ å›¾ç‰‡æˆ–PDF<span class="required">*</span></label>
                        <div class="upload-area" id="uploadArea">
                            <input type="file" id="ocrFileInput" accept="image/*,application/pdf" multiple style="display: none;">
                            <div class="upload-placeholder" id="uploadPlaceholder">
                                <div class="upload-icon">ğŸ“</div>
                                <p>ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</p>
                                <p class="hint">æ”¯æŒå›¾ç‰‡ï¼ˆJPGã€PNGã€GIFï¼‰å’ŒPDFæ–‡ä»¶</p>
                                <p class="hint">å¯ä¸€æ¬¡æ€§ä¸Šä¼ å¤šä¸ªæ–‡ä»¶</p>
                            </div>
                            <div class="file-list" id="fileList"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>è¯†åˆ«è¯­è¨€</label>
                        <select id="ocrLanguage">
                            <option value="chi_sim">ç®€ä½“ä¸­æ–‡</option>
                            <option value="chi_tra">ç¹ä½“ä¸­æ–‡</option>
                            <option value="eng">è‹±æ–‡</option>
                            <option value="chi_sim+eng">ä¸­è‹±æ–‡æ··åˆ</option>
                            <option value="jpn">æ—¥è¯­</option>
                            <option value="kor">éŸ©è¯­</option>
                        </select>
                        <div class="hint">é€‰æ‹©è¦è¯†åˆ«çš„æ–‡å­—è¯­è¨€</div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>ç›®æ ‡è¯»è€…<span class="required">*</span></label>
                            <select id="ocrTargetAudience" required>
                                <option value="">è¯·é€‰æ‹©...</option>
                                <option value="general">æ™®é€šå¤§ä¼— / åƒç“œç¾¤ä¼—</option>
                                <option value="creator">è‡ªåª’ä½“ / å†…å®¹åˆ›ä½œè€…</option>
                                <option value="business">äº§å“ / è¿è¥ / å•†ä¸šäºº</option>
                                <option value="tech">æŠ€æœ¯ä»ä¸šè€…</option>
                                <option value="emotional">æƒ…ç»ªå…±é¸£å‹è¯»è€…</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>è¯†åˆ«åæ“ä½œ</label>
                            <select id="ocrAction">
                                <option value="copy">ä»…å¤åˆ¶åˆ°å‰ªè´´æ¿</option>
                                <option value="paste">å¤åˆ¶åˆ°æ–‡å­—ç²˜è´´</option>
                                <option value="rewrite">è¯†åˆ«åæ™ºèƒ½æ”¹å†™</option>
                            </select>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button type="button" class="btn btn-primary" id="startOcrBtn">
                            <span>ğŸ”</span> å¼€å§‹è¯†åˆ«
                        </button>
                        <button type="button" class="btn btn-secondary" id="clearOcrBtn">
                            <span>ğŸ—‘ï¸</span> æ¸…ç©º
                        </button>
                    </div>

                    <!-- è¯†åˆ«è¿›åº¦ -->
                    <div class="ocr-progress" id="ocrProgress" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <p class="progress-text" id="progressText">æ­£åœ¨è¯†åˆ«...</p>
                    </div>

                    <!-- è¯†åˆ«ç»“æœ -->
                    <div class="ocr-result" id="ocrResult" style="display: none;">
                        <h3>è¯†åˆ«ç»“æœ</h3>
                        <textarea id="ocrOutput" rows="12" readonly></textarea>
                        <div class="btn-group">
                            <button type="button" class="btn btn-success" id="copyOcrResultBtn">
                                <span>ğŸ“‹</span> å¤åˆ¶ç»“æœ
                            </button>
                            <button type="button" class="btn btn-primary" id="rewriteOcrResultBtn">
                                <span>âœï¸</span> æ™ºèƒ½æ”¹å†™
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ–‡å­—ç²˜è´´é€‰é¡¹å¡ -->
            <div class="tab-content" id="pasteTab">
                <div class="card form-section">
                    <h2 class="card-title">ğŸ“‹ æ–‡å­—å†…å®¹ç²˜è´´ä¸é‡å†™</h2>

                    <div class="form-group">
                        <label>ç›®æ ‡è¯»è€…<span class="required">*</span></label>
                        <select id="pasteTargetAudience" required>
                            <option value="">è¯·é€‰æ‹©...</option>
                            <option value="general">æ™®é€šå¤§ä¼— / åƒç“œç¾¤ä¼—</option>
                            <option value="creator">è‡ªåª’ä½“ / å†…å®¹åˆ›ä½œè€…</option>
                            <option value="business">äº§å“ / è¿è¥ / å•†ä¸šäºº</option>
                            <option value="tech">æŠ€æœ¯ä»ä¸šè€…</option>
                            <option value="emotional">æƒ…ç»ªå…±é¸£å‹è¯»è€…</option>
                        </select>
                        <div class="hint">é€‰æ‹©ç›®æ ‡è¯»è€…ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨é€‚é…å†™ä½œé£æ ¼</div>
                    </div>

                    <div class="form-group">
                        <label>ç²˜è´´å†…å®¹<span class="required">*</span></label>
                        <textarea id="pasteContent" rows="12" placeholder="å°†éœ€è¦æ”¹å†™çš„æ–‡ç« å†…å®¹ç²˜è´´åˆ°è¿™é‡Œ...

æ”¯æŒï¼š
- æ–‡ç« åˆç¨¿çš„æ¶¦è‰²å’Œæ”¹å†™
- å­¦æœ¯è®ºæ–‡è½¬åŒ–ä¸ºé€šä¿—æ–‡ç« 
- æŠ€æœ¯æ–‡æ¡£è½¬åŒ–ä¸ºç§‘æ™®å†…å®¹
- é•¿æ–‡æç‚¼å’Œç²¾ç®€
- è°ƒæ•´æ–‡é£ä»¥é€‚åº”ä¸åŒè¯»è€…ç¾¤ä½“"></textarea>
                        <div class="hint">ç²˜è´´åŸå§‹æ–‡ç« å†…å®¹ï¼Œç³»ç»Ÿä¼šæ ¹æ®ç›®æ ‡è¯»è€…è‡ªåŠ¨æ”¹å†™</div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>æ”¹å†™æ–¹å‘</label>
                            <select id="rewriteDirection">
                                <option value="adaptive">æ™ºèƒ½é€‚é…ï¼ˆæ ¹æ®ç›®æ ‡è¯»è€…è‡ªåŠ¨è°ƒæ•´ï¼‰</option>
                                <option value="simplify">ç®€åŒ–ï¼ˆæ›´é€šä¿—æ˜“æ‡‚ï¼‰</option>
                                <option value="deepen">æ·±åŒ–ï¼ˆå¢åŠ æ·±åº¦å’Œä¸“ä¸šæ€§ï¼‰</option>
                                <option value="shorten">ç²¾ç®€ï¼ˆæç‚¼è¦ç‚¹ï¼‰</option>
                                <option value="expand">æ‰©å±•ï¼ˆè¡¥å……ç»†èŠ‚ï¼‰</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>é¢å¤–è¦æ±‚ï¼ˆå¯é€‰ï¼‰</label>
                            <textarea id="pasteExtraNotes" rows="3" placeholder="ä¾‹å¦‚ï¼š&#10;- ä¿ç•™æ ¸å¿ƒæ¡ˆä¾‹&#10;- å¢åŠ æ•°æ®åˆ†æ&#10;- è°ƒæ•´è¯­æ°”æ›´è½»æ¾"></textarea>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button type="button" class="btn btn-primary" id="pasteRewriteBtn">
                            <span>âœï¸</span> æ™ºèƒ½æ”¹å†™
                        </button>
                        <button type="button" class="btn btn-secondary" id="clearPasteBtn">
                            <span>ğŸ—‘ï¸</span> æ¸…ç©º
                        </button>
                    </div>
                </div>
            </div>

            <!-- URLæŠ“å–é€‰é¡¹å¡ -->
            <div class="tab-content" id="urlTab">
                <div class="card form-section">
                    <h2 class="card-title">ğŸ”— URLæ–‡ç« æŠ“å–ä¸é‡å†™</h2>

                    <div class="form-group">
                        <label>ç›®æ ‡è¯»è€…<span class="required">*</span></label>
                        <select id="urlTargetAudience" required>
                            <option value="">è¯·é€‰æ‹©...</option>
                            <option value="general">æ™®é€šå¤§ä¼— / åƒç“œç¾¤ä¼—</option>
                            <option value="creator">è‡ªåª’ä½“ / å†…å®¹åˆ›ä½œè€…</option>
                            <option value="business">äº§å“ / è¿è¥ / å•†ä¸šäºº</option>
                            <option value="tech">æŠ€æœ¯ä»ä¸šè€…</option>
                            <option value="emotional">æƒ…ç»ªå…±é¸£å‹è¯»è€…</option>
                        </select>
                        <div class="hint">ç³»ç»Ÿä¼šæ ¹æ®ç›®æ ‡è¯»è€…è‡ªåŠ¨è°ƒæ•´å†™ä½œé£æ ¼</div>
                    </div>

                    <div class="form-group">
                        <label>æ–‡ç« é“¾æ¥<span class="required">*</span></label>
                        <input type="text" id="articleUrl" placeholder="ç²˜è´´æ–‡ç« é“¾æ¥ï¼Œæ”¯æŒä¸­æ–‡å’Œè‹±æ–‡ç½‘ç«™">
                        <div class="hint">æ³¨æ„ï¼šç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼ŒæŸäº›ç½‘ç«™å¯èƒ½æ— æ³•ç›´æ¥æŠ“å–</div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>é“¾æ¥ç±»å‹</label>
                            <select id="urlType">
                                <option value="chinese">ä¸­æ–‡æ–‡ç« </option>
                                <option value="english">è‹±æ–‡æ–‡ç« </option>
                                <option value="auto">è‡ªåŠ¨æ£€æµ‹</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>æ”¹å†™æ–¹å‘</label>
                            <select id="urlRewriteDirection">
                                <option value="adaptive">æ™ºèƒ½é€‚é…ï¼ˆæ ¹æ®ç›®æ ‡è¯»è€…è‡ªåŠ¨è°ƒæ•´ï¼‰</option>
                                <option value="simplify">ç®€åŒ–ï¼ˆæ›´é€šä¿—æ˜“æ‡‚ï¼‰</option>
                                <option value="deepen">æ·±åŒ–ï¼ˆå¢åŠ æ·±åº¦å’Œä¸“ä¸šæ€§ï¼‰</option>
                                <option value="shorten">ç²¾ç®€ï¼ˆæç‚¼è¦ç‚¹ï¼‰</option>
                                <option value="expand">æ‰©å±•ï¼ˆè¡¥å……ç»†èŠ‚ï¼‰</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>é¢å¤–è¦æ±‚ï¼ˆå¯é€‰ï¼‰</label>
                        <textarea id="urlExtraNotes" rows="3" placeholder="ä¾‹å¦‚ï¼š&#10;- å¢åŠ æ›´å¤šæ¡ˆä¾‹&#10;- è°ƒæ•´è¯­æ°”æ›´è½»æ¾&#10;- è¡¥å……æœ€æ–°çš„æ•°æ®"></textarea>
                    </div>

                    <div class="btn-group">
                        <button type="button" class="btn btn-primary" id="fetchUrlBtn">
                            <span>ğŸŒ</span> æŠ“å–å¹¶æ”¹å†™æ–‡ç« 
                        </button>
                        <button type="button" class="btn btn-secondary" id="clearUrlBtn">
                            <span>ğŸ—‘ï¸</span> æ¸…ç©º
                        </button>
                    </div>

                    <!-- æ€»ç»“é¢„è§ˆåŒºåŸŸ -->
                    <div class="summary-preview" id="summaryPreview" style="display: none;">
                        <div class="summary-preview-title">ğŸ“‹ åŸæ–‡æ€»ç»“</div>
                        <div id="summaryContent"></div>
                    </div>
                </div>
            </div>

            <!-- APIé…ç½®é€‰é¡¹å¡ -->
            <div class="tab-content" id="apiTab">
                <div class="card">
                    <h2 class="card-title">âš™ï¸ AIæ¨¡å‹APIé…ç½®</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">
                        é…ç½®æ‚¨çš„APIå¯†é’¥åï¼Œå¯ä»¥ä½¿ç”¨çœŸå®çš„å¤§æ¨¡å‹è¿›è¡Œå†…å®¹ç”Ÿæˆã€‚APIå¯†é’¥å°†ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°å­˜å‚¨ä¸­ã€‚
                    </p>

                    <div class="api-config-section">
                        <div class="api-config-title">
                            <span class="api-config-toggle" onclick="toggleApiConfig('deepseek')">
                                <span id="deepseekToggle">â–¶</span> DeepSeek API
                            </span>
                        </div>
                        <div class="api-config-content" id="deepseekConfig">
                            <div class="form-group">
                                <label>API Key</label>
                                <input type="password" id="deepseekApiKey" placeholder="sk-xxxxxxxxxxxxxxxxxxxxxxxx">
                                <div class="hint">è·å–åœ°å€ï¼š<a href="https://platform.deepseek.com/" target="_blank">https://platform.deepseek.com/</a></div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>API Base URL</label>
                                    <input type="text" id="deepseekBaseUrl" value="https://api.deepseek.com/v1">
                                </div>
                                <div class="form-group">
                                    <label>æ¨¡å‹åç§°</label>
                                    <input type="text" id="deepseekModel" value="deepseek-chat">
                                </div>
                            </div>
                            <button type="button" class="btn btn-success" onclick="saveApiKey('deepseek')">ğŸ’¾ ä¿å­˜é…ç½®</button>
                            <button type="button" class="btn btn-secondary" onclick="testApiKey('deepseek')">ğŸ§ª æµ‹è¯•è¿æ¥</button>
                        </div>
                    </div>

                    <div class="api-config-section">
                        <div class="api-config-title">
                            <span class="api-config-toggle" onclick="toggleApiConfig('doubao')">
                                <span id="doubaoToggle">â–¶</span> è±†åŒ… API
                            </span>
                        </div>
                        <div class="api-config-content" id="doubaoConfig">
                            <div class="form-group">
                                <label>API Key</label>
                                <input type="password" id="doubaoApiKey" placeholder="xxxxxxxxxxxxxxxxxxxxxxxx">
                                <div class="hint">è·å–åœ°å€ï¼š<a href="https://console.volcengine.com/ark" target="_blank">https://console.volcengine.com/ark</a></div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>API Base URL</label>
                                    <input type="text" id="doubaoBaseUrl" value="https://ark.cn-beijing.volces.com/api/v3">
                                </div>
                                <div class="form-group">
                                    <label>æ¨¡å‹åç§°</label>
                                    <input type="text" id="doubaoModel" value="ep-20241201234567-xxxxx">
                                    <div class="hint">è¯·å¡«å…¥æ‚¨çš„æ¨¡å‹ç«¯ç‚¹ID</div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-success" onclick="saveApiKey('doubao')">ğŸ’¾ ä¿å­˜é…ç½®</button>
                            <button type="button" class="btn btn-secondary" onclick="testApiKey('doubao')">ğŸ§ª æµ‹è¯•è¿æ¥</button>
                        </div>
                    </div>

                    <div class="api-config-section">
                        <div class="api-config-title">
                            <span class="api-config-toggle" onclick="toggleApiConfig('kimi')">
                                <span id="kimiToggle">â–¶</span> Kimi API
                            </span>
                        </div>
                        <div class="api-config-content" id="kimiConfig">
                            <div class="form-group">
                                <label>API Key</label>
                                <input type="password" id="kimiApiKey" placeholder="sk-xxxxxxxxxxxxxxxxxxxxxxxx">
                                <div class="hint">è·å–åœ°å€ï¼š<a href="https://platform.moonshot.cn/" target="_blank">https://platform.moonshot.cn/</a></div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>API Base URL</label>
                                    <input type="text" id="kimiBaseUrl" value="https://api.moonshot.cn/v1">
                                </div>
                                <div class="form-group">
                                    <label>æ¨¡å‹åç§°</label>
                                    <input type="text" id="kimiModel" value="moonshot-v1-8k">
                                </div>
                            </div>
                            <button type="button" class="btn btn-success" onclick="saveApiKey('kimi')">ğŸ’¾ ä¿å­˜é…ç½®</button>
                            <button type="button" class="btn btn-secondary" onclick="testApiKey('kimi')">ğŸ§ª æµ‹è¯•è¿æ¥</button>
                        </div>
                    </div>

                    <div class="api-config-section">
                        <div class="api-config-title">
                            <span class="api-config-toggle" onclick="toggleApiConfig('tongyi')">
                                <span id="tongyiToggle">â–¶</span> é€šä¹‰åƒé—® API
                            </span>
                        </div>
                        <div class="api-config-content" id="tongyiConfig">
                            <div class="form-group">
                                <label>API Key</label>
                                <input type="password" id="tongyiApiKey" placeholder="sk-xxxxxxxxxxxxxxxxxxxxxxxx">
                                <div class="hint">è·å–åœ°å€ï¼š<a href="https://dashscope.aliyuncs.com/" target="_blank">https://dashscope.aliyuncs.com/</a></div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>API Base URL</label>
                                    <input type="text" id="tongyiBaseUrl" value="https://dashscope.aliyuncs.com/compatible-mode/v1">
                                </div>
                                <div class="form-group">
                                    <label>æ¨¡å‹åç§°</label>
                                    <input type="text" id="tongyiModel" value="qwen-plus">
                                </div>
                            </div>
                            <button type="button" class="btn btn-success" onclick="saveApiKey('tongyi')">ğŸ’¾ ä¿å­˜é…ç½®</button>
                            <button type="button" class="btn btn-secondary" onclick="testApiKey('tongyi')">ğŸ§ª æµ‹è¯•è¿æ¥</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è¿›åº¦å±•ç¤ºåŒºåŸŸ -->
            <div class="progress-section" id="progressSection" style="display: none;">
                <h3 class="progress-title">âš¡ åˆ›ä½œæµç¨‹è¿›åº¦</h3>
                <div class="progress-steps" id="progressSteps">
                    <div class="step-item pending" id="step1">
                        <div class="step-icon">1</div>
                        <div class="step-label">é€‰é¢˜æ ¡éªŒ</div>
                        <div class="step-status">å¾…æ‰§è¡Œ</div>
                    </div>
                    <div class="step-item pending" id="step2">
                        <div class="step-icon">2</div>
                        <div class="step-label">AIç”Ÿæˆåˆç¨¿</div>
                        <div class="step-status">å¾…æ‰§è¡Œ</div>
                    </div>
                    <div class="step-item pending" id="step3">
                        <div class="step-icon">3</div>
                        <div class="step-label">æ ‡é¢˜åˆ›ä½œ</div>
                        <div class="step-status">å¾…æ‰§è¡Œ</div>
                    </div>
                    <div class="step-item pending" id="step4">
                        <div class="step-icon">4</div>
                        <div class="step-label">æ’ç‰ˆå»ºè®®ç”Ÿæˆ</div>
                        <div class="step-status">å¾…æ‰§è¡Œ</div>
                    </div>
                </div>
            </div>

            <!-- ç»“æœå±•ç¤ºåŒºåŸŸ -->
            <div class="results-section" id="resultsSection">
                <!-- æ–‡ç« 1å¡ç‰‡ -->
                <div class="result-card" id="articleCard1">
                    <div class="result-card-header">
                        <h3 class="result-card-title">ğŸ“„ æ–‡ç«  1</h3>
                        <button type="button" class="btn btn-success copy-btn" data-target="articleContent1">
                            <span>ğŸ“‹</span> å¤åˆ¶
                        </button>
                    </div>
                    <div class="result-content" id="articleContent1"></div>
                </div>

                <!-- æ–‡ç« 2å¡ç‰‡ -->
                <div class="result-card" id="articleCard2">
                    <div class="result-card-header">
                        <h3 class="result-card-title">ğŸ“„ æ–‡ç«  2</h3>
                        <button type="button" class="btn btn-success copy-btn" data-target="articleContent2">
                            <span>ğŸ“‹</span> å¤åˆ¶
                        </button>
                    </div>
                    <div class="result-content" id="articleContent2"></div>
                </div>

                <!-- æ ‡é¢˜åˆ›ä½œå¡ç‰‡ -->
                <div class="result-card" id="titleCard">
                    <div class="result-card-header">
                        <h3 class="result-card-title">ğŸ¯ å…¬ä¼—å·æ ‡é¢˜ (5ä¸ª)</h3>
                        <button type="button" class="btn btn-success copy-btn" data-target="titleContent">
                            <span>ğŸ“‹</span> å¤åˆ¶
                        </button>
                    </div>
                    <div class="result-content" id="titleContent"></div>
                </div>

                <!-- æ’ç‰ˆå»ºè®®å¡ç‰‡ -->
                <div class="result-card" id="formatCard">
                    <div class="result-card-header">
                        <h3 class="result-card-title">ğŸ“ æ’ç‰ˆå»ºè®®</h3>
                        <button type="button" class="btn btn-success copy-btn" data-target="formatContent">
                            <span>ğŸ“‹</span> å¤åˆ¶
                        </button>
                    </div>
                    <div class="result-content" id="formatContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- åŠ è½½é®ç½©å±‚ -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingText">æ­£åœ¨å¤„ç†...</div>
    </div>

    <!-- æç¤ºä¿¡æ¯ -->
    <div class="toast" id="toast">âœ… æ“ä½œæˆåŠŸ</div>

    <script>
        /**
         * ============================================
         * é»‘é˜¿çŒ«å¾®ä¿¡å…¬ä¼—å·åˆ›ä½œå·¥å…· V3 (å¤šæ–‡ç« ç”Ÿæˆç‰ˆ)
         * ============================================
         * æ ¸å¿ƒç‰¹æ€§ï¼š
         * 1. å®Œå…¨ç”±ç›®æ ‡è¯»è€…å†³å®šçš„å†™ä½œç³»ç»Ÿ
         * 2. æ”¯æŒä¸€æ¬¡ç”Ÿæˆä¸¤ç¯‡æ–‡ç« 
         * 3. æ ¹æ®æ–‡ç« å†…å®¹ç”Ÿæˆ5ä¸ªå…¬ä¼—å·æ ‡é¢˜
         * 4. åŠ¨æ€ä½œè€…èº«ä»½åˆ‡æ¢
         * 5. è¯»è€…é€‚é…çš„å™äº‹ç»“æ„
         * 6. æ”¯æŒæ–‡å­—ç²˜è´´åŠŸèƒ½
         * 7. URLæŠ“å–ä¸æ™ºèƒ½æ”¹å†™
         * 8. å¤šæ¨¡å‹APIé›†æˆ
         * ============================================
         */

        // ==================== åº”ç”¨çŠ¶æ€ç®¡ç† ====================
        const AppState = {
            currentStep: 0,
            generatedData: {
                articles: [],
                titles: [],
                format: ''
            },
            apiConfig: {},
            currentTab: 'manual'
        };

        // ==================== è¯»è€…ç¾¤ä½“é…ç½® ====================
        const audienceProfiles = {
            general: {
                name: 'æ™®é€šå¤§ä¼— / åƒç“œç¾¤ä¼—',
                role: 'ä¼šè®²æ•…äº‹çš„æ—è§‚è€…',
                characteristics: {
                    cognitiveLevel: 'ä½ä¸“ä¸šèƒŒæ™¯ï¼Œä¾èµ–ç”Ÿæ´»å¸¸è¯†',
                    languagePreference: 'å£è¯­åŒ–ã€ç”Ÿæ´»åŒ–ã€è®²æ•…äº‹',
                    attentionSpan: 'çŸ­ï¼Œéœ€è¦å†²çªå’Œåè½¬ç»´æŒå…´è¶£',
                    motivation: 'å¥½å¥‡å¿ƒã€å…«å¦å¿ƒç†ã€æƒ…æ„Ÿå…±é¸£'
                },
                narrativeStructure: `äº‹ä»¶ â†’ å†²çª â†’ åè½¬ â†’ ä¸ºä»€ä¹ˆä¼šè¿™æ ·`,
                writingStyle: `åƒèŠå¤©ä¸€æ ·è‡ªç„¶ï¼Œç”¨ç”Ÿæ´»åœºæ™¯åšç±»æ¯”ï¼Œä¸è®²å¤§é“ç†`,
                technicalConstraint: `âŒ ç¦æ­¢å‡ºç°ä¸“ä¸šæœ¯è¯­ï¼Œå¿…é¡»ç”¨ç”Ÿæ´»åŒ–ç±»æ¯”`,
                toneGuidelines: [
                    'å…‹åˆ¶è¡¨è¾¾ï¼Œä¸ç…½æƒ…',
                    'ç”¨"æˆ‘æ³¨æ„åˆ°"è€Œé"æˆ‘è®¤ä¸º"',
                    'å¤šè®²æ•…äº‹ï¼Œå°‘è®²é“ç†'
                ]
            },
            creator: {
                name: 'è‡ªåª’ä½“ / å†…å®¹åˆ›ä½œè€…',
                role: 'æ‹†å¥—è·¯ã€è®²æ–¹æ³•çš„åŒè¡Œ',
                characteristics: {
                    cognitiveLevel: 'æœ‰åˆ›ä½œç»éªŒï¼Œæ‡‚æ–¹æ³•è®º',
                    languagePreference: 'ä¸“ä¸šä½†ä¸æ™¦æ¶©ï¼Œå¼ºè°ƒå¯æ“ä½œæ€§',
                    attentionSpan: 'ä¸­ç­‰ï¼Œé‡è§†å¹²è´§å¯†åº¦',
                    motivation: 'å­¦åˆ°å¯å¤ç”¨çš„æ–¹æ³•å’ŒæŠ€å·§'
                },
                narrativeStructure: `ç°è±¡ â†’ å¥—è·¯ â†’ å¯å¤ç”¨ç»éªŒ â†’ é£é™©æé†’`,
                writingStyle: `æ·±åº¦å‰–æçˆ†æ¬¾æ¡ˆä¾‹èƒŒåçš„æ–¹æ³•è®ºï¼Œå®ç”¨æ€§å¼º`,
                technicalConstraint: `âœ… å…è®¸ä¸“ä¸šæœ¯è¯­ï¼Œä½†éœ€é…åˆå®æˆ˜æ¡ˆä¾‹`,
                toneGuidelines: [
                    'ç›´æ¥ã€ä¸ç»•å¼¯å­',
                    'ç”¨"æˆ‘è¯•è¿‡"æ›¿ä»£"æ®è¯´"',
                    'å¼ºè°ƒæ•°æ®å’Œç»“æœ'
                ]
            },
            business: {
                name: 'äº§å“ / è¿è¥ / å•†ä¸šäºº',
                role: 'åˆ†æç°è±¡èƒŒåé€»è¾‘çš„è§‚å¯Ÿè€…',
                characteristics: {
                    cognitiveLevel: 'é«˜ï¼Œæœ‰å•†ä¸šæ€ç»´',
                    languagePreference: 'æ•°æ®é©±åŠ¨ã€é€»è¾‘ä¸¥å¯†',
                    attentionSpan: 'é•¿ï¼Œé‡è§†æ·±åº¦åˆ†æ',
                    motivation: 'æ´å¯Ÿå•†ä¸šè¶‹åŠ¿ï¼Œå‘ç°æœºä¼š'
                },
                narrativeStructure: `è¡¨è±¡ â†’ æ¿€åŠ±æœºåˆ¶ â†’ åˆ©ç›Šåˆ†é… â†’ é•¿æœŸå½±å“`,
                writingStyle: `å•†ä¸šè§†è§’åˆ†æï¼Œæ•°æ®é©±åŠ¨ï¼Œæ´å¯Ÿè¶‹åŠ¿`,
                technicalConstraint: `âœ… å…è®¸å•†ä¸š/æŠ€æœ¯æœ¯è¯­ï¼Œéœ€æœ‰æ•°æ®æ”¯æ’‘`,
                toneGuidelines: [
                    'å®¢è§‚ã€ä¸­ç«‹',
                    'ç”¨"æ•°æ®æ˜¾ç¤º"æ›¿ä»£"æˆ‘è§‰å¾—"',
                    'å…³æ³¨ROIå’Œå¯æŒç»­æ€§'
                ]
            },
            tech: {
                name: 'æŠ€æœ¯ä»ä¸šè€…',
                role: 'å†·é™æ‹†è§£ç³»ç»Ÿå’Œæœºåˆ¶çš„åˆ†æè€…',
                characteristics: {
                    cognitiveLevel: 'æé«˜ï¼ŒæŠ€æœ¯èƒŒæ™¯æ·±åš',
                    languagePreference: 'ç²¾ç¡®ã€ä¸¥è°¨ã€ä¸“ä¸š',
                    attentionSpan: 'é•¿ï¼Œé‡è§†æŠ€æœ¯ç»†èŠ‚',
                    motivation: 'ç†è§£æŠ€æœ¯åŸç†ï¼Œå­¦ä¹ æœ€ä½³å®è·µ'
                },
                narrativeStructure: `ç°è±¡ â†’ è§¦å‘æ¡ä»¶ â†’ ç³»ç»Ÿååº” â†’ ç»“æœ`,
                writingStyle: `æŠ€æœ¯ç»†èŠ‚é€å½»ï¼Œé€»è¾‘ä¸¥å¯†ï¼Œä¸“ä¸šåº¦é«˜`,
                technicalConstraint: `âœ… é¼“åŠ±ä¸“ä¸šæœ¯è¯­ï¼Œé¼“åŠ±æ·±å…¥æŠ€æœ¯ç»†èŠ‚`,
                toneGuidelines: [
                    'ç²¾ç¡®ã€ä¸å¤¸å¤§',
                    'ç”¨"å®æµ‹æ•°æ®"æ›¿ä»£"ç†è®ºä¸Š"',
                    'æä¾›ä»£ç ç¤ºä¾‹æˆ–æ¶æ„å›¾'
                ]
            },
            emotional: {
                name: 'æƒ…ç»ªå…±é¸£å‹è¯»è€…',
                role: 'ä»£æ›¿ä»–ä»¬è¯´å‡ºå¿ƒé‡Œè¯çš„äºº',
                characteristics: {
                    cognitiveLevel: 'æƒ…æ„Ÿå¯¼å‘ï¼Œä¸è¿½æ±‚é€»è¾‘ä¸¥å¯†',
                    languagePreference: 'æ„Ÿæ€§ã€æ¸©æŸ”ã€æœ‰æ¸©åº¦',
                    attentionSpan: 'çœ‹å¿ƒæƒ…ï¼Œé‡è§†æƒ…æ„Ÿè¿æ¥',
                    motivation: 'æ‰¾åˆ°ç†è§£ã€è·å¾—å®‰æ…°ã€è¢«çœ‹è§'
                },
                narrativeStructure: `æƒ…æ„Ÿåœºæ™¯ â†’ ç—›ç‚¹å…±é¸£ â†’ æ•…äº‹è®²è¿° â†’ æƒ…æ„Ÿå‡å`,
                writingStyle: `æƒ…æ„Ÿå…±é¸£ï¼Œæ•…äº‹æ€§å¼ºï¼Œè§¦åŠ¨äººå¿ƒ`,
                technicalConstraint: `âŒ ä¸¥æ ¼ç¦æ­¢ä¸“ä¸šæœ¯è¯­ï¼Œä¸€åˆ‡ä¸ºæƒ…æ„Ÿè®©è·¯`,
                toneGuidelines: [
                    'æ¸©æŸ”ã€æœ‰åŒç†å¿ƒ',
                    'ç”¨"æˆ‘ä»¬éƒ½æ›¾"æ›¿ä»£"ä½ åº”è¯¥"',
                    'å¤šç”¨é—®å¥å¼•å¯¼æ€è€ƒ'
                ]
            }
        };

        // ==================== DOMå…ƒç´ å¼•ç”¨ ====================
        const elements = {
            // æ‰‹åŠ¨åˆ›ä½œè¡¨å•
            targetAudience: document.getElementById('targetAudience'),
            pasteTargetAudience: document.getElementById('pasteTargetAudience'),
            urlTargetAudience: document.getElementById('urlTargetAudience'),
            ocrTargetAudience: document.getElementById('ocrTargetAudience'),
            readerTypeExplanation: document.getElementById('readerTypeExplanation'),
            audienceHint: document.getElementById('audienceHint'),
            topic: document.getElementById('topic'),
            coreView: document.getElementById('coreView'),
            wordCount: document.getElementById('wordCount'),
            keywords: document.getElementById('keywords'),
            aiModel: document.getElementById('aiModel'),
            sourceLanguage: document.getElementById('sourceLanguage'),
            articleCount: document.getElementById('articleCount'),
            createForm: document.getElementById('createForm'),

            // æ–‡å­—ç²˜è´´ç›¸å…³
            pasteContent: document.getElementById('pasteContent'),
            rewriteDirection: document.getElementById('rewriteDirection'),
            pasteExtraNotes: document.getElementById('pasteExtraNotes'),
            urlRewriteDirection: document.getElementById('urlRewriteDirection'),

            // URLç›¸å…³
            articleUrl: document.getElementById('articleUrl'),
            urlType: document.getElementById('urlType'),
            urlExtraNotes: document.getElementById('urlExtraNotes'),
            summaryPreview: document.getElementById('summaryPreview'),
            summaryContent: document.getElementById('summaryContent'),

            // æŒ‰é’®
            startWorkflowBtn: document.getElementById('startWorkflowBtn'),
            clearBtn: document.getElementById('clearBtn'),
            pasteRewriteBtn: document.getElementById('pasteRewriteBtn'),
            clearPasteBtn: document.getElementById('clearPasteBtn'),
            fetchUrlBtn: document.getElementById('fetchUrlBtn'),
            clearUrlBtn: document.getElementById('clearUrlBtn'),

            // OCRç›¸å…³å…ƒç´ 
            ocrFileInput: document.getElementById('ocrFileInput'),
            uploadArea: document.getElementById('uploadArea'),
            uploadPlaceholder: document.getElementById('uploadPlaceholder'),
            fileList: document.getElementById('fileList'),
            ocrLanguage: document.getElementById('ocrLanguage'),
            ocrAction: document.getElementById('ocrAction'),
            startOcrBtn: document.getElementById('startOcrBtn'),
            clearOcrBtn: document.getElementById('clearOcrBtn'),
            ocrProgress: document.getElementById('ocrProgress'),
            progressFill: document.getElementById('progressFill'),
            progressText: document.getElementById('progressText'),
            ocrResult: document.getElementById('ocrResult'),
            ocrOutput: document.getElementById('ocrOutput'),
            copyOcrResultBtn: document.getElementById('copyOcrResultBtn'),
            rewriteOcrResultBtn: document.getElementById('rewriteOcrResultBtn'),

            // è¿›åº¦å’Œç»“æœ
            progressSection: document.getElementById('progressSection'),
            resultsSection: document.getElementById('resultsSection'),
            articleCard1: document.getElementById('articleCard1'),
            articleCard2: document.getElementById('articleCard2'),
            titleCard: document.getElementById('titleCard'),
            formatCard: document.getElementById('formatCard'),
            articleContent1: document.getElementById('articleContent1'),
            articleContent2: document.getElementById('articleContent2'),
            titleContent: document.getElementById('titleContent'),
            formatContent: document.getElementById('formatContent'),

            // åŠ è½½å’Œæç¤º
            loadingOverlay: document.getElementById('loadingOverlay'),
            loadingText: document.getElementById('loadingText'),
            toast: document.getElementById('toast')
        };

        // ==================== åˆå§‹åŒ–äº‹ä»¶ç›‘å¬ ====================
        function initEventListeners() {
            // é€‰é¡¹å¡åˆ‡æ¢
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    switchTab(tabName);
                });
            });

            // ç›®æ ‡è¯»è€…é€‰æ‹©ç›‘å¬
            elements.targetAudience.addEventListener('change', (e) => {
                updateReaderTypeExplanation(e.target.value);
            });

            elements.pasteTargetAudience.addEventListener('change', (e) => {
                // å¯ä»¥æ·»åŠ åŠ¨æ€æç¤º
            });

            elements.urlTargetAudience.addEventListener('change', (e) => {
                // å¯ä»¥æ·»åŠ åŠ¨æ€æç¤º
            });

            // OCRä¸Šä¼ åŒºåŸŸäº‹ä»¶
            elements.uploadArea.addEventListener('click', (e) => {
                if (e.target === elements.uploadArea || e.target.closest('.upload-placeholder')) {
                    elements.ocrFileInput.click();
                }
            });

            elements.uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                elements.uploadArea.classList.add('dragover');
            });

            elements.uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                elements.uploadArea.classList.remove('dragover');
            });

            elements.uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                elements.uploadArea.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });

            elements.ocrFileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });

            // OCRæŒ‰é’®äº‹ä»¶
            elements.startOcrBtn.addEventListener('click', startOCR);
            elements.clearOcrBtn.addEventListener('click', clearOCR);
            elements.copyOcrResultBtn.addEventListener('click', () => {
                copyText(elements.ocrOutput.value);
            });
            elements.rewriteOcrResultBtn.addEventListener('click', rewriteOCRResult);

            // æŒ‰é’®äº‹ä»¶
            elements.startWorkflowBtn.addEventListener('click', startWorkflow);
            elements.clearBtn.addEventListener('click', clearForm);
            elements.pasteRewriteBtn.addEventListener('click', pasteAndRewrite);
            elements.clearPasteBtn.addEventListener('click', clearPasteForm);
            elements.fetchUrlBtn.addEventListener('click', fetchAndRewriteArticle);
            elements.clearUrlBtn.addEventListener('click', clearUrlForm);

            // å¤åˆ¶æŒ‰é’®äº‹ä»¶å§”æ‰˜
            elements.resultsSection.addEventListener('click', (e) => {
                if (e.target.closest('.copy-btn')) {
                    const btn = e.target.closest('.copy-btn');
                    const targetId = btn.dataset.target;
                    copyContent(targetId);
                }
            });

            // æ ‡é¢˜é¡¹ç‚¹å‡»å¤åˆ¶
            elements.titleContent.addEventListener('click', (e) => {
                if (e.target.classList.contains('title-item')) {
                    copyText(e.target.textContent);
                }
            });

            // åŠ è½½ä¿å­˜çš„APIé…ç½®
            loadSavedApiConfigs();
        }

        // ==================== æ›´æ–°è¯»è€…ç±»å‹è¯´æ˜ ====================
        function updateReaderTypeExplanation(audienceKey) {
            const profile = audienceProfiles[audienceKey];
            if (!profile) {
                elements.readerTypeExplanation.innerHTML = '';
                return;
            }

            const html = `
                <div class="reader-type-card">
                    <span class="role-tag">${profile.role}</span>
                    <h4>${profile.name}</h4>
                    <p><strong>è®¤çŸ¥ç‰¹ç‚¹ï¼š</strong>${profile.characteristics.cognitiveLevel}</p>
                    <p><strong>è¯­è¨€åå¥½ï¼š</strong>${profile.characteristics.languagePreference}</p>
                    <p><strong>å™äº‹ç»“æ„ï¼š</strong>${profile.narrativeStructure}</p>
                    <p><strong>æŠ€æœ¯çº¦æŸï¼š</strong>${profile.technicalConstraint}</p>
                </div>
            `;

            elements.readerTypeExplanation.innerHTML = html;
        }

        // ==================== é€‰é¡¹å¡åˆ‡æ¢ ====================
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === tabName + 'Tab');
            });

            AppState.currentTab = tabName;
        }

        // ==================== ç”Ÿæˆè¯»è€…é©±åŠ¨çš„æç¤ºè¯ ====================
        function generateReaderDrivenPrompt(params, articleIndex = 1) {
            const profile = audienceProfiles[params.targetAudience];
            if (!profile) {
                throw new Error('æ— æ•ˆçš„ç›®æ ‡è¯»è€…ç±»å‹');
            }

            const variationNote = articleIndex === 1
                ? 'è¿™æ˜¯ç¬¬ä¸€ç¯‡æ–‡ç« ï¼Œè¯·é‡‡ç”¨æ ‡å‡†çš„å™äº‹ç»“æ„ã€‚'
                : 'è¿™æ˜¯ç¬¬äºŒç¯‡æ–‡ç« ï¼Œè¯·ä¸ç¬¬ä¸€ç¯‡æ–‡ç« æœ‰æ‰€åŒºåˆ«ï¼Œå°è¯•ä¸åŒçš„åˆ‡å…¥è§’åº¦æˆ–æ¡ˆä¾‹ï¼Œä¿æŒæ ¸å¿ƒè§‚ç‚¹ä½†å˜æ¢è¡¨è¾¾æ–¹å¼ã€‚';

            return `
ã€ç›®æ ‡è¯»è€…ã€‘
${profile.name}
- è®¤çŸ¥ç‰¹ç‚¹ï¼š${profile.characteristics.cognitiveLevel}
- è¯­è¨€åå¥½ï¼š${profile.characteristics.languagePreference}
- æ³¨æ„åŠ›ç‰¹ç‚¹ï¼š${profile.characteristics.attentionSpan}
- é˜…è¯»åŠ¨æœºï¼š${profile.characteristics.motivation}

ã€ä½ çš„èº«ä»½ã€‘
ä½ æ˜¯ï¼š${profile.role}

ã€å†™ä½œä¸»é¢˜ã€‘
${params.topic}

ã€æ ¸å¿ƒè§‚ç‚¹ã€‘
${params.coreView}

ã€æ–‡ç« å˜åŒ–è¦æ±‚ã€‘
${variationNote}

==================== ä¸€ã€è¯»è€…é©±åŠ¨åŸåˆ™ï¼ˆå¿…é¡»ä¸¥æ ¼éµå®ˆï¼‰====================

1. ä½ å†™çš„ä¸æ˜¯"æ­£ç¡®çš„æ–‡ç« "ï¼Œè€Œæ˜¯"è¿™ä¸ªè¯»è€…æ„¿æ„çœ‹å®Œçš„æ–‡ç« "
2. ä½ ä¸èƒ½ç‚«è€€çŸ¥è¯†ï¼Œåªèƒ½ä½¿ç”¨è¯¥è¯»è€…å¤©ç„¶èƒ½ç†è§£çš„è¯­è¨€
3. å¦‚æœå†…å®¹è®©è¯¥è¯»è€…è§‰å¾—"è¿™ä¸æ˜¯å†™ç»™æˆ‘çš„"ï¼Œè¯·ç«‹åˆ»æ”¹å†™

==================== äºŒã€å™äº‹ç»“æ„ ====================

è¯·ä¸¥æ ¼éµå¾ªä»¥ä¸‹å™äº‹ç»“æ„ï¼š
${profile.narrativeStructure}

==================== ä¸‰ã€æŠ€æœ¯å†…å®¹ä½¿ç”¨è§„åˆ™ ====================

${profile.technicalConstraint}

==================== å››ã€è¯­æ°”æŒ‡å— ====================

${profile.toneGuidelines.map(guideline => `- ${guideline}`).join('\n')}

==================== äº”ã€è¾“å‡ºè¦æ±‚ ====================

- ç›®æ ‡å­—æ•°ï¼š${params.wordCount}å­—
- è¯­è¨€ï¼šè‡ªç„¶ã€åƒçœŸäººå†™çš„ï¼Œä¸è¦æ€»ç»“è…”
- è¯­æ°”ï¼šå…‹åˆ¶ã€æœ‰åˆ¤æ–­ï¼Œä½†ä¸è¯´æ•™
- ç¯‡å¹…ï¼šå…¬ä¼—å·ä¸­ç­‰é•¿åº¦

âŒ ç»å¯¹ç¦æ­¢ä½¿ç”¨ï¼š
- "ä»æŸç§æ„ä¹‰ä¸Šè¯´"
- "æœ¬è´¨ä¸Š"
- "æˆ‘ä»¬å¯ä»¥çœ‹åˆ°"
- ä»»ä½• AI å¸¸ç”¨æ€»ç»“å¥å¼

==================== å…­ã€æœ€ç»ˆè‡ªæ£€ï¼ˆå¿…é¡»æ‰§è¡Œï¼‰====================

åœ¨è¾“å‡ºæ­£æ–‡å‰ï¼Œè¯·ä½ è‡ªæŸ¥ï¼š
1. æ˜¯å¦å‡ºç°ä¸ç¬¦åˆç›®æ ‡è¯»è€…è®¤çŸ¥çš„å†…å®¹
2. æ˜¯å¦æœ‰"æˆ‘çŸ¥é“ä½†ä½ ä¸éœ€è¦çŸ¥é“"çš„æ®µè½
3. æ˜¯å¦æœ‰æ˜æ˜¾ AI å‘³æˆ–æ¨¡æ¿å‘³

å¦‚æœ‰ï¼Œè¯·ç›´æ¥åˆ é™¤æˆ–é‡å†™ã€‚

==================== å¼€å§‹åˆ›ä½œ ====================

è¯·æ ¹æ®ä»¥ä¸Šè¦æ±‚ï¼Œåˆ›ä½œä¸€ç¯‡ç¬¦åˆ${profile.name}é˜…è¯»ä¹ æƒ¯çš„å¾®ä¿¡å…¬ä¼—å·æ–‡ç« ã€‚
`;
        }

        // ==================== å¯åŠ¨æ‰‹åŠ¨åˆ›ä½œå·¥ä½œæµ ====================
        async function startWorkflow() {
            if (!validateForm()) {
                return;
            }

            elements.progressSection.style.display = 'block';
            elements.resultsSection.style.display = 'grid';
            elements.startWorkflowBtn.disabled = true;

            // éšè—ä¹‹å‰çš„æ–‡ç« 2å¡ç‰‡ï¼ˆå¦‚æœåªç”Ÿæˆ1ç¯‡ï¼‰
            const articleCount = parseInt(elements.articleCount.value);

            try {
                await executeStep(1, validateTopic);
                await executeStep(2, generateArticles);
                await executeStep(3, generateTitles);
                await executeStep(4, generateFormat);

                showToast('âœ… åˆ›ä½œå·¥ä½œæµå·²å®Œæˆï¼');
            } catch (error) {
                showToast('âŒ å·¥ä½œæµæ‰§è¡Œå¤±è´¥ï¼š' + error.message, true);
            } finally {
                elements.startWorkflowBtn.disabled = false;
            }
        }

        async function executeStep(stepNumber, stepFunction) {
            const stepElement = document.getElementById(`step${stepNumber}`);
            updateStepStatus(stepElement, 'processing');

            try {
                await stepFunction();
                updateStepStatus(stepElement, 'completed');
            } catch (error) {
                updateStepStatus(stepElement, 'failed');
                throw error;
            }
        }

        function updateStepStatus(stepElement, status) {
            // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
            stepElement.classList.remove('pending', 'processing', 'completed', 'failed');
            stepElement.classList.add(status);

            // è·å–æ­¥éª¤åºå·
            const stepNumber = stepElement.id.replace('step', '');
            const iconElement = stepElement.querySelector('.step-icon');
            const statusElement = stepElement.querySelector('.step-status');

            // æ ¹æ®çŠ¶æ€æ›´æ–°å›¾æ ‡å’Œæ–‡å­—
            switch (status) {
                case 'pending':
                    iconElement.textContent = stepNumber;
                    statusElement.textContent = 'å¾…æ‰§è¡Œ';
                    break;
                case 'processing':
                    iconElement.textContent = 'âš™';
                    statusElement.textContent = 'æ‰§è¡Œä¸­...';
                    break;
                case 'completed':
                    iconElement.textContent = 'âœ“';
                    statusElement.textContent = 'å·²å®Œæˆ';
                    // æ›´æ–°è¿›åº¦æ¡è¿æ¥çº¿
                    updateProgressBar(stepNumber);
                    break;
                case 'failed':
                    iconElement.textContent = 'âœ—';
                    statusElement.textContent = 'å¤±è´¥';
                    break;
            }
        }

        // æ›´æ–°è¿›åº¦æ¡è¿æ¥çº¿é¢œè‰²
        function updateProgressBar(completedStepNumber) {
            const progressSteps = document.getElementById('progressSteps');
            // ç§»é™¤æ‰€æœ‰å®ŒæˆçŠ¶æ€ç±»
            progressSteps.classList.remove(
                'step-1-completed',
                'step-2-completed',
                'step-3-completed',
                'step-4-completed'
            );
            // æ·»åŠ å½“å‰å®ŒæˆçŠ¶æ€ç±»
            progressSteps.classList.add(`step-${completedStepNumber}-completed`);
        }

        async function validateTopic() {
            showLoading('ğŸ” æ­£åœ¨åˆ†æç›®æ ‡è¯»è€…...');
            const params = getFormParams();
            await simulateDelay(1000);

            if (params.topic.length < 5) {
                throw new Error('é€‰é¢˜ä¸»é¢˜è¿‡çŸ­');
            }

            if (params.coreView.split('\n').filter(v => v.trim()).length < 2) {
                throw new Error('è¯·è‡³å°‘æä¾›2ä¸ªæ ¸å¿ƒè§‚ç‚¹');
            }

            hideLoading();
            showToast('âœ… è¯»è€…åˆ†æå®Œæˆ');
        }

        // ==================== ç”Ÿæˆå¤šç¯‡æ–‡ç«  ====================
        async function generateArticles() {
            const params = getFormParams();
            const articleCount = parseInt(elements.articleCount.value);
            const aiModel = elements.aiModel.value;
            const apiConfig = getApiConfig(aiModel);

            AppState.generatedData.articles = [];

            for (let i = 1; i <= articleCount; i++) {
                showLoading(`âœï¸ æ­£åœ¨ç”Ÿæˆç¬¬ ${i} ç¯‡æ–‡ç« ...`);

                let article;
                if (aiModel === 'simulate') {
                    await simulateDelay(2000);
                    article = generateSimulatedArticle(params, i);
                } else {
                    const prompt = generateReaderDrivenPrompt(params, i);
                    article = await callAIModel(aiModel, apiConfig, prompt);
                }

                AppState.generatedData.articles.push(article);

                // æ˜¾ç¤ºæ–‡ç« å†…å®¹
                if (i === 1) {
                    elements.articleContent1.textContent = article;
                    elements.articleCard1.classList.add('show');
                } else if (i === 2) {
                    elements.articleContent2.textContent = article;
                    elements.articleCard2.classList.add('show');
                }
            }

            hideLoading();
            showToast(`âœ… å·²ç”Ÿæˆ ${articleCount} ç¯‡æ–‡ç« `);
        }

        function generateSimulatedArticle(params, articleIndex) {
            const profile = audienceProfiles[params.targetAudience];
            const views = params.coreView.split('\n').filter(v => v.trim());

            const articleType = articleIndex === 1 ? 'ï¼ˆç‰ˆæœ¬ä¸€ï¼‰' : 'ï¼ˆç‰ˆæœ¬äºŒ - ä¸åŒè§’åº¦ï¼‰';

            let article = `# ${params.topic} ${articleType}\n\n`;
            article += `## å¼•è¨€\n\n`;
            article += `ä½œä¸º${profile.role}ï¼Œæˆ‘æƒ³å’Œå¤§å®¶èŠèŠ${params.topic}ã€‚\n\n`;
            article += `è¿™ç¯‡æ–‡ç« ä¼šæŒ‰ç…§"${profile.narrativeStructure}"çš„é€»è¾‘å±•å¼€ã€‚\n\n`;

            views.forEach((view, index) => {
                article += `## ${index + 1}. ${view.trim()}\n\n`;
                article += `### ä¸ºä»€ä¹ˆè¿™é‡è¦\n`;
                article += `ä»${profile.name}çš„è§’åº¦æ¥çœ‹...\n\n`;
                article += `### å…·ä½“åˆ†æ\n`;
                article += `- è¦ç‚¹ä¸€ï¼šè¯¦ç»†è¯´æ˜\n`;
                article += `- è¦ç‚¹äºŒï¼šæ•°æ®/æ¡ˆä¾‹æ”¯æ’‘\n`;
                article += `- è¦ç‚¹ä¸‰ï¼šåº”ç”¨å»ºè®®\n\n`;
            });

            article += `## æ€»ç»“\n\n`;
            article += `å¸Œæœ›è¿™ç¯‡æ–‡ç« å¯¹${profile.name}æœ‰æ‰€å¸®åŠ©ã€‚\n\n`;
            article += `æ„Ÿè°¢é˜…è¯»ï¼Œæ¬¢è¿ç‚¹èµã€åœ¨çœ‹ã€è½¬å‘ï¼\n`;

            return article;
        }

        // ==================== ç”Ÿæˆ5ä¸ªæ ‡é¢˜ ====================
        async function generateTitles() {
            showLoading('ğŸ¯ æ­£åœ¨åˆ›ä½œæ ‡é¢˜...');
            const params = getFormParams();
            const aiModel = elements.aiModel.value;
            const apiConfig = getApiConfig(aiModel);

            // è·å–ç¬¬ä¸€ç¯‡æ–‡ç« å†…å®¹ç”¨äºç”Ÿæˆæ ‡é¢˜
            const articleContent = AppState.generatedData.articles[0] || '';

            if (aiModel === 'simulate') {
                await simulateDelay(1000);
                const titles = {
                    all: [
                        `ğŸ”¥ ${params.topic}ï¼šä¸ºä»€ä¹ˆ90%çš„äººéƒ½ç†è§£é”™äº†ï¼Ÿ`,
                        `ğŸ’¡ æ­ç§˜${params.topic}çš„çœŸç›¸ï¼Œçœ‹å®Œè¿™ç¯‡å°±å¤Ÿäº†`,
                        `âš¡ ${params.topic}å¤§çˆ†å‘ï¼è¿™3ä¸ªå…³é”®ä¿¡å·ä½ å¿…é¡»çŸ¥é“`,
                        `ğŸ¯ ä¸çœ‹åæ‚”ï¼${params.topic}å…¶å®æ²¡é‚£ä¹ˆéš¾`,
                        `ğŸ“– ${params.topic}å®Œå…¨æŒ‡å—ï¼šä»å…¥é—¨åˆ°ç²¾é€š`
                    ]
                };

                AppState.generatedData.titles = titles;
                displayTitles(titles);
                elements.titleCard.classList.add('show');

                hideLoading();
                showToast('âœ… æ ‡é¢˜åˆ›ä½œå®Œæˆ');
                return;
            }

            try {
                const profile = audienceProfiles[params.targetAudience];
                const prompt = `è¯·ä¸ºä¸»é¢˜"${params.topic}"åˆ›ä½œ5ä¸ªå¾®ä¿¡å…¬ä¼—å·æ ‡é¢˜ã€‚

ç›®æ ‡è¯»è€…ï¼š${profile.name}
è¯»è€…åå¥½ï¼š${profile.characteristics.languagePreference}
æ–‡ç« å†…å®¹ç‰‡æ®µï¼š${articleContent.substring(0, 500)}

è¦æ±‚ï¼š
1. æ ‡é¢˜è¦å¸å¼•ç›®æ ‡è¯»è€…ç‚¹å‡»
2. ç¬¦åˆå¾®ä¿¡å…¬ä¼—å·æ ‡é¢˜çš„ç‰¹ç‚¹ï¼ˆ15-25å­—ï¼‰
3. åŒ…å«emojiè¡¨æƒ…å¢åŠ å¸å¼•åŠ›
4. æ ‡é¢˜é£æ ¼è¦å¤šæ ·åŒ–ï¼ˆæ‚¬å¿µå‹ã€å¹²è´§å‹ã€æƒ…æ„Ÿå‹ç­‰ï¼‰

è¯·ç›´æ¥è¿”å›5ä¸ªæ ‡é¢˜ï¼Œæ¯è¡Œä¸€ä¸ªï¼Œä¸è¦JSONæ ¼å¼ã€‚`;

                const result = await callAIModel(aiModel, apiConfig, prompt);
                const titles = parseFiveTitles(result);

                AppState.generatedData.titles = titles;
                displayTitles(titles);
                elements.titleCard.classList.add('show');

                hideLoading();
                showToast('âœ… æ ‡é¢˜åˆ›ä½œå®Œæˆ');
            } catch (error) {
                hideLoading();
                throw error;
            }
        }

        function parseFiveTitles(text) {
            const lines = text.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);

            // æå–æ ‡é¢˜ï¼ˆå»é™¤åºå·ã€ç¬¦å·ç­‰ï¼‰
            const titles = [];
            for (const line of lines) {
                // å»é™¤åºå·å‰ç¼€
                let title = line.replace(/^[\d\.\ã€\-\â€¢]+[\s]*/, '').trim();

                // å»é™¤å¯èƒ½çš„å¼•å·
                title = title.replace(/^["'"""]|["'"""]$/g, '').trim();

                if (title.length > 5 && title.length < 100) {
                    titles.push(title);
                }

                if (titles.length >= 5) break;
            }

            // å¦‚æœè§£æå‡ºçš„æ ‡é¢˜ä¸è¶³5ä¸ªï¼Œè¡¥å……é»˜è®¤æ ‡é¢˜
            while (titles.length < 5) {
                titles.push(`ğŸ“ æ ‡é¢˜ ${titles.length + 1}ï¼ˆéœ€è¦å®Œå–„ï¼‰`);
            }

            return { all: titles.slice(0, 5) };
        }

        async function generateFormat() {
            showLoading('ğŸ“ æ­£åœ¨ç”Ÿæˆæ’ç‰ˆå»ºè®®...');
            await simulateDelay(1000);

            const format = `# ğŸ“± å¾®ä¿¡å…¬ä¼—å·æ’ç‰ˆå»ºè®®

### ä¸€ã€æ ‡é¢˜å±‚çº§
- ä¸»æ ‡é¢˜ï¼š18-20pxï¼ŒåŠ ç²—å±…ä¸­
- äºŒçº§æ ‡é¢˜ï¼š16-18pxï¼ŒåŠ ç²—å·¦å¯¹é½
- ä¸‰çº§æ ‡é¢˜ï¼š14-16pxï¼ŒåŠ ç²—å·¦å¯¹é½

### äºŒã€æ®µè½è®¾è®¡
- æ¯æ®µ3-5è¡Œï¼Œé¿å…å¤§æ®µæ–‡å­—
- è¡Œé—´è·1.75-2å€
- æ®µè½é—´ç©ºä¸€è¡Œ

### ä¸‰ã€è§†è§‰å…ƒç´ 
- æ¯300-500å­—æ’å…¥é…å›¾
- é‡ç‚¹å†…å®¹åŠ ç²—çªå‡º
- ä½¿ç”¨å¼•ç”¨å—å±•ç¤ºæ•°æ®

### å››ã€ç§»åŠ¨ç«¯ä¼˜åŒ–
- æ­£æ–‡14-16pxå­—å·
- å·¦å³è¾¹è·15-20px
- ä¸ä½¿ç”¨é¦–è¡Œç¼©è¿›

ğŸ’¡ å¥½çš„æ’ç‰ˆèƒ½æå‡30%ä»¥ä¸Šçš„é˜…è¯»å®Œæˆç‡ï¼`;

            AppState.generatedData.format = format;
            elements.formatContent.textContent = format;
            elements.formatCard.classList.add('show');

            hideLoading();
            showToast('âœ… æ’ç‰ˆå»ºè®®ç”Ÿæˆå®Œæˆ');
        }

        function displayTitles(titles) {
            let html = '';
            titles.all.forEach((title, index) => {
                html += `<div class="title-item">${index + 1}. ${title}</div>`;
            });
            elements.titleContent.innerHTML = html;
        }

        // ==================== æ–‡å­—ç²˜è´´æ”¹å†™ ====================
        async function pasteAndRewrite() {
            const content = elements.pasteContent.value.trim();
            const targetAudience = elements.pasteTargetAudience.value;
            const rewriteDirection = elements.rewriteDirection.value;
            const extraNotes = elements.pasteExtraNotes.value.trim();

            if (!content) {
                showToast('âŒ è¯·ç²˜è´´éœ€è¦æ”¹å†™çš„å†…å®¹', true);
                elements.pasteContent.focus();
                return;
            }

            if (!targetAudience) {
                showToast('âŒ è¯·é€‰æ‹©ç›®æ ‡è¯»è€…', true);
                elements.pasteTargetAudience.focus();
                return;
            }

            try {
                showLoading('âœï¸ æ­£åœ¨æ™ºèƒ½æ”¹å†™...');

                const profile = audienceProfiles[targetAudience];
                const aiModel = elements.aiModel.value;
                const apiConfig = getApiConfig(aiModel);

                let prompt = `
ã€åŸæ–‡å†…å®¹ã€‘
${content.substring(0, 8000)}

ã€ç›®æ ‡è¯»è€…ã€‘
${profile.name}
- ä½ çš„èº«ä»½ï¼š${profile.role}
- å™äº‹ç»“æ„ï¼š${profile.narrativeStructure}
- æŠ€æœ¯çº¦æŸï¼š${profile.technicalConstraint}
- è¯­è¨€åå¥½ï¼š${profile.characteristics.languagePreference}

ã€æ”¹å†™æ–¹å‘ã€‘
${rewriteDirection === 'adaptive' ? 'æ™ºèƒ½é€‚é…ï¼ˆæ ¹æ®ç›®æ ‡è¯»è€…è‡ªåŠ¨è°ƒæ•´ï¼‰' : rewriteDirection}

ã€æ”¹å†™è¦æ±‚ã€‘
1. å®Œå…¨æŒ‰ç…§ç›®æ ‡è¯»è€…çš„è®¤çŸ¥ç‰¹ç‚¹å’Œè¯­è¨€åå¥½è¿›è¡Œæ”¹å†™
2. ä¿æŒåŸæ–‡æ ¸å¿ƒè§‚ç‚¹å’Œå…³é”®ä¿¡æ¯
3. ä¸¥æ ¼æŒ‰ç…§æŒ‡å®šçš„å™äº‹ç»“æ„é‡ç»„å†…å®¹
4. åˆ é™¤æ‰€æœ‰ä¸ç¬¦åˆç›®æ ‡è¯»è€…è®¤çŸ¥çš„ä¸“ä¸šæœ¯è¯­
5. ä½¿ç”¨è‡ªç„¶ã€å£è¯­åŒ–çš„è¡¨è¾¾ï¼Œé¿å…AIè…”
6. å­—æ•°æ§åˆ¶åœ¨${Math.max(800, content.length * 0.8)}-${Math.min(3000, content.length * 1.5)}å­—ä¹‹é—´

ã€è¯­æ°”è¦æ±‚ã€‘
${profile.toneGuidelines.map(g => `- ${g}`).join('\n')}

ã€ç¦æ­¢ä½¿ç”¨çš„è¡¨è¾¾ã€‘
- "ä»æŸç§æ„ä¹‰ä¸Šè¯´"
- "æœ¬è´¨ä¸Š"
- "æˆ‘ä»¬å¯ä»¥çœ‹åˆ°"
- ä»»ä½•æ€»ç»“æ€§çš„è¿‡æ¸¡å¥

${extraNotes ? `\nã€é¢å¤–è¦æ±‚ã€‘\n${extraNotes}` : ''}

è¯·å¼€å§‹æ”¹å†™ï¼š
`;

                let result;
                if (aiModel === 'simulate') {
                    await simulateDelay(2000);
                    result = simulatePasteRewrite(content, profile);
                } else {
                    result = await callAIModel(aiModel, apiConfig, prompt);
                }

                // æ˜¾ç¤ºç»“æœ
                elements.articleContent1.textContent = result;
                elements.articleCard1.classList.add('show');
                elements.resultsSection.style.display = 'grid';

                // ç”Ÿæˆæ ‡é¢˜
                showLoading('ğŸ¯ æ­£åœ¨ç”Ÿæˆæ ‡é¢˜...');
                const titles = await generateTitlesFromContent(result, targetAudience);
                displayTitles(titles);
                elements.titleCard.classList.add('show');

                hideLoading();
                showToast('âœ… æ”¹å†™å®Œæˆï¼');

            } catch (error) {
                hideLoading();
                showToast('âŒ æ”¹å†™å¤±è´¥ï¼š' + error.message, true);
                console.error('æ”¹å†™é”™è¯¯:', error);
            }
        }

        // ==================== æ¨¡æ‹Ÿç²˜è´´æ”¹å†™ ====================
        function simulatePasteRewrite(content, profile) {
            return `# æ”¹å†™åçš„æ–‡ç« 

ï¼ˆè¿™æ˜¯æ¨¡æ‹Ÿè¾“å‡ºï¼Œå®é™…ä½¿ç”¨æ—¶ä¼šè°ƒç”¨AIæ¨¡å‹è¿›è¡Œå®Œæ•´æ”¹å†™ï¼‰

ã€ç›®æ ‡è¯»è€…ã€‘${profile.name}
ã€æ”¹å†™æ–¹å‘ã€‘æ™ºèƒ½é€‚é…

åŸæ–‡å·²æ ¹æ®${profile.name}çš„é˜…è¯»ä¹ æƒ¯è¿›è¡Œæ”¹å†™ï¼š
- é‡‡ç”¨"${profile.narrativeStructure}"çš„å™äº‹ç»“æ„
- ä½¿ç”¨${profile.characteristics.languagePreference}çš„è¡¨è¾¾æ–¹å¼
- éµå¾ª${profile.technicalConstraint}

åŸæ–‡é•¿åº¦ï¼š${content.length}å­—
æ”¹å†™åé¢„è®¡é•¿åº¦ï¼š${Math.round(content.length * 0.9)}å­—

---
${content.substring(0, 500)}...
`;
        }

        // ==================== URLæ–‡ç« æŠ“å–ä¸æ”¹å†™ ====================
        async function fetchAndRewriteArticle() {
            const url = elements.articleUrl.value.trim();
            const urlType = elements.urlType.value;
            const targetAudience = elements.urlTargetAudience.value;
            const rewriteDirection = elements.urlRewriteDirection.value;
            const extraNotes = elements.urlExtraNotes.value.trim();

            if (!url) {
                showToast('âŒ è¯·è¾“å…¥æ–‡ç« é“¾æ¥', true);
                elements.articleUrl.focus();
                return;
            }

            if (!isValidUrl(url)) {
                showToast('âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„URLåœ°å€', true);
                elements.articleUrl.focus();
                return;
            }

            if (!targetAudience) {
                showToast('âŒ è¯·é€‰æ‹©ç›®æ ‡è¯»è€…', true);
                elements.urlTargetAudience.focus();
                return;
            }

            try {
                showLoading('ğŸŒ æ­£åœ¨æŠ“å–æ–‡ç« å†…å®¹...');
                const articleContent = await fetchArticleContent(url);

                showLoading('ğŸ” æ­£åœ¨åˆ†ææ–‡ç« è¯­è¨€...');
                let contentToSummarize = articleContent;
                const isEnglishContent = detectLanguage(articleContent) === 'en';

                if (isEnglishContent || urlType === 'english') {
                    showLoading('ğŸŒ æ­£åœ¨ç¿»è¯‘æ–‡ç« å†…å®¹...');
                    contentToSummarize = await translateText(articleContent, 'en', 'zh');
                }

                showLoading('ğŸ“ æ­£åœ¨ç”Ÿæˆæ–‡ç« æ€»ç»“...');
                const summary = await generateSummary(contentToSummarize);

                elements.summaryContent.textContent = summary;
                elements.summaryPreview.style.display = 'block';

                showLoading('âœï¸ æ­£åœ¨æ”¹å†™æ–‡ç« ...');
                const profile = audienceProfiles[targetAudience];
                const aiModel = elements.aiModel.value;
                const apiConfig = getApiConfig(aiModel);

                let prompt = `
ã€åŸæ–‡æ€»ç»“ã€‘
${summary}

ã€ç›®æ ‡è¯»è€…ã€‘
${profile.name}
- ä½ çš„èº«ä»½ï¼š${profile.role}
- å™äº‹ç»“æ„ï¼š${profile.narrativeStructure}
- æŠ€æœ¯çº¦æŸï¼š${profile.technicalConstraint}
- è¯­è¨€åå¥½ï¼š${profile.characteristics.languagePreference}

ã€æ”¹å†™æ–¹å‘ã€‘
${rewriteDirection === 'adaptive' ? 'æ™ºèƒ½é€‚é…ï¼ˆæ ¹æ®ç›®æ ‡è¯»è€…è‡ªåŠ¨è°ƒæ•´ï¼‰' : rewriteDirection}

ã€æ”¹å†™è¦æ±‚ã€‘
1. å®Œå…¨æŒ‰ç…§ç›®æ ‡è¯»è€…çš„è®¤çŸ¥ç‰¹ç‚¹å’Œè¯­è¨€åå¥½è¿›è¡Œæ”¹å†™
2. æ ¹æ®æ€»ç»“æ‰©å±•ä¸ºä¸€ç¯‡å®Œæ•´çš„å…¬ä¼—å·æ–‡ç« 
3. ä¸¥æ ¼æŒ‰ç…§æŒ‡å®šçš„å™äº‹ç»“æ„ç»„ç»‡å†…å®¹
4. å­—æ•°1500-2000å­—
5. é€‚å½“ä½¿ç”¨emojiè¡¨æƒ…
6. ç»“å°¾è¦æœ‰äº’åŠ¨å¼•å¯¼

ã€è¯­æ°”è¦æ±‚ã€‘
${profile.toneGuidelines.map(g => `- ${g}`).join('\n')}

${extraNotes ? `\nã€é¢å¤–è¦æ±‚ã€‘\n${extraNotes}` : ''}

è¯·å¼€å§‹æ”¹å†™ï¼š
`;

                let rewrittenArticle;
                if (aiModel === 'simulate') {
                    await simulateDelay(2000);
                    rewrittenArticle = simulateUrlRewrite(summary, profile);
                } else {
                    rewrittenArticle = await callAIModel(aiModel, apiConfig, prompt);
                }

                showLoading('ğŸ¯ æ­£åœ¨ç”Ÿæˆæ ‡é¢˜...');
                const titles = await generateTitlesFromContent(rewrittenArticle, targetAudience);

                displayUrlResults(rewrittenArticle, titles, summary);
                hideLoading();
                showToast('âœ… æ–‡ç« æŠ“å–ä¸æ”¹å†™å®Œæˆï¼');

            } catch (error) {
                hideLoading();
                showToast('âŒ å¤„ç†å¤±è´¥ï¼š' + error.message, true);
                console.error('URLæŠ“å–é”™è¯¯:', error);
            }
        }

        // ==================== æ¨¡æ‹ŸURLæ”¹å†™ ====================
        function simulateUrlRewrite(summary, profile) {
            return `# æ ¹æ®åŸæ–‡æ”¹å†™çš„æ–‡ç« 

ã€ç›®æ ‡è¯»è€…ã€‘${profile.name}
ã€å™äº‹ç»“æ„ã€‘${profile.narrativeStructure}

åŸºäºä»¥ä¸‹æ€»ç»“è¿›è¡Œæ”¹å†™ï¼š
${summary.substring(0, 300)}...

ï¼ˆå®Œæ•´æ”¹å†™å†…å®¹éœ€è¦é…ç½®APIåä½¿ç”¨çœŸå®AIæ¨¡å‹ç”Ÿæˆï¼‰
`;
        }

        // ==================== æ ¹æ®å†…å®¹ç”Ÿæˆæ ‡é¢˜ ====================
        async function generateTitlesFromContent(content, targetAudience) {
            const profile = audienceProfiles[targetAudience];
            const aiModel = elements.aiModel.value;
            const apiConfig = getApiConfig(aiModel);

            if (aiModel === 'simulate') {
                await simulateDelay(1000);
                return {
                    all: [
                        'ğŸ”¥ æ­ç§˜çœŸç›¸ï¼šä¸ºä»€ä¹ˆ90%çš„äººéƒ½ç†è§£é”™äº†ï¼Ÿ',
                        'ğŸ’¡ çœ‹å®Œè¿™ç¯‡å°±å¤Ÿäº†ï¼Œå¹²è´§æ»¡æ»¡ï¼',
                        'âš¡ ä¸çœ‹åæ‚”ï¼è¿™3ä¸ªå…³é”®ä¿¡å·ä½ å¿…é¡»çŸ¥é“',
                        'ğŸ¯ å…³é”®ä¿¡æ¯ï¼Œå»ºè®®æ”¶è—',
                        'ğŸ“– æ·±åº¦è§£æï¼Œå€¼å¾—ä¸€çœ‹'
                    ]
                };
            }

            try {
                const prompt = `è¯·ä¸ºä»¥ä¸‹æ–‡ç« å†…å®¹åˆ›ä½œ5ä¸ªå¾®ä¿¡å…¬ä¼—å·æ ‡é¢˜ã€‚

ç›®æ ‡è¯»è€…ï¼š${profile.name}
è¯»è€…åå¥½ï¼š${profile.characteristics.languagePreference}

è¦æ±‚ï¼š
1. æ ‡é¢˜è¦å¸å¼•ç›®æ ‡è¯»è€…ç‚¹å‡»
2. ç¬¦åˆå¾®ä¿¡å…¬ä¼—å·æ ‡é¢˜çš„ç‰¹ç‚¹ï¼ˆ15-25å­—ï¼‰
3. åŒ…å«emojiè¡¨æƒ…å¢åŠ å¸å¼•åŠ›
4. æ ‡é¢˜é£æ ¼è¦å¤šæ ·åŒ–

è¯·ç›´æ¥è¿”å›5ä¸ªæ ‡é¢˜ï¼Œæ¯è¡Œä¸€ä¸ªï¼Œä¸è¦JSONæ ¼å¼ã€‚

æ–‡ç« å†…å®¹ï¼š
${content.substring(0, 1000)}`;

                const result = await callAIModel(aiModel, apiConfig, prompt);
                return parseFiveTitles(result);
            } catch (error) {
                throw new Error('ç”Ÿæˆæ ‡é¢˜å¤±è´¥ï¼š' + error.message);
            }
        }

        function displayUrlResults(article, titles, summary) {
            elements.articleContent1.textContent = article;
            elements.articleCard1.classList.add('show');

            displayTitles(titles);
            elements.titleCard.classList.add('show');

            const format = `# ğŸ“± å¾®ä¿¡å…¬ä¼—å·æ’ç‰ˆå»ºè®®

- æ ‡é¢˜ä½¿ç”¨18-20pxå­—å·ï¼ŒåŠ ç²—å±…ä¸­
- æ­£æ–‡ä½¿ç”¨14-16pxå­—å·ï¼Œ1.75å€è¡Œè·
- æ¯æ®µ3-5è¡Œï¼Œé¿å…å¤§æ®µæ–‡å­—
- æ¯300-500å­—æ’å…¥ä¸€å¼ é…å›¾
- é‡ç‚¹å†…å®¹ç”¨åŠ ç²—æˆ–å¼•ç”¨æ ¼å¼çªå‡º`;

            elements.formatContent.textContent = format;
            elements.formatCard.classList.add('show');
            elements.resultsSection.style.display = 'grid';
        }

        // ==================== å·¥å…·å‡½æ•° ====================
        function validateForm() {
            const topic = elements.topic.value.trim();
            const coreView = elements.coreView.value.trim();
            const targetAudience = elements.targetAudience.value;

            if (!topic) {
                showToast('âŒ è¯·è¾“å…¥é€‰é¢˜ä¸»é¢˜', true);
                elements.topic.focus();
                return false;
            }

            if (!coreView) {
                showToast('âŒ è¯·è¾“å…¥æ ¸å¿ƒè§‚ç‚¹', true);
                elements.coreView.focus();
                return false;
            }

            if (!targetAudience) {
                showToast('âŒ è¯·é€‰æ‹©ç›®æ ‡è¯»è€…', true);
                elements.targetAudience.focus();
                return false;
            }

            return true;
        }

        function getFormParams() {
            return {
                topic: elements.topic.value.trim(),
                coreView: elements.coreView.value.trim(),
                wordCount: parseInt(elements.wordCount.value),
                targetAudience: elements.targetAudience.value,
                keywords: elements.keywords.value.trim()
            };
        }

        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        function simulateDelay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function copyContent(targetId) {
            const targetElement = document.getElementById(targetId);
            const content = targetElement.textContent || targetElement.innerText;

            try {
                await navigator.clipboard.writeText(content);
                showToast('âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            } catch (err) {
                copyText(content);
            }
        }

        function copyText(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();

            try {
                document.execCommand('copy');
                showToast('âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            } catch (err) {
                showToast('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', true);
            } finally {
                document.body.removeChild(textarea);
            }
        }

        function showLoading(text) {
            elements.loadingText.textContent = text;
            elements.loadingOverlay.classList.add('active');
        }

        function hideLoading() {
            elements.loadingOverlay.classList.remove('active');
        }

        function showToast(message, isError = false) {
            elements.toast.textContent = message;
            elements.toast.classList.toggle('error', isError);
            elements.toast.classList.add('show');

            setTimeout(() => {
                elements.toast.classList.remove('show');
            }, 3000);
        }

        function clearForm() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†…å®¹å—ï¼Ÿ')) {
                elements.createForm.reset();
                elements.progressSection.style.display = 'none';
                elements.resultsSection.style.display = 'none';
                elements.articleCard1.classList.remove('show');
                elements.articleCard2.classList.remove('show');
                elements.titleCard.classList.remove('show');
                elements.formatCard.classList.remove('show');
                elements.readerTypeExplanation.innerHTML = '';

                // é‡ç½®æ‰€æœ‰æ­¥éª¤çŠ¶æ€
                ['step1', 'step2', 'step3', 'step4'].forEach(id => {
                    updateStepStatus(document.getElementById(id), 'pending');
                });

                // é‡ç½®è¿›åº¦æ¡è¿æ¥çº¿
                const progressSteps = document.getElementById('progressSteps');
                progressSteps.classList.remove(
                    'step-1-completed',
                    'step-2-completed',
                    'step-3-completed',
                    'step-4-completed'
                );

                elements.articleContent1.textContent = '';
                elements.articleContent2.textContent = '';
                elements.titleContent.textContent = '';
                elements.formatContent.textContent = '';

                showToast('âœ… å·²æ¸…ç©ºæ‰€æœ‰å†…å®¹');
            }
        }

        function clearPasteForm() {
            elements.pasteContent.value = '';
            elements.pasteExtraNotes.value = '';
            elements.resultsSection.style.display = 'none';
            elements.articleCard1.classList.remove('show');
            elements.articleCard2.classList.remove('show');
            elements.titleCard.classList.remove('show');
            elements.formatCard.classList.remove('show');
            showToast('âœ… å·²æ¸…ç©ºç²˜è´´è¡¨å•');
        }

        function clearUrlForm() {
            elements.articleUrl.value = '';
            elements.urlExtraNotes.value = '';
            elements.summaryPreview.style.display = 'none';
            elements.summaryContent.textContent = '';
            elements.resultsSection.style.display = 'none';
            elements.articleCard1.classList.remove('show');
            elements.articleCard2.classList.remove('show');
            elements.titleCard.classList.remove('show');
            elements.formatCard.classList.remove('show');
            showToast('âœ… å·²æ¸…ç©ºURLè¡¨å•');
        }

        // ==================== APIé…ç½®ç®¡ç† ====================
        function toggleApiConfig(model) {
            const config = document.getElementById(model + 'Config');
            const toggle = document.getElementById(model + 'Toggle');
            config.classList.toggle('show');
            toggle.textContent = config.classList.contains('show') ? 'â–¼' : 'â–¶';
        }

        function saveApiKey(model) {
            const config = {
                apiKey: document.getElementById(model + 'ApiKey').value,
                baseUrl: document.getElementById(model + 'BaseUrl').value,
                model: document.getElementById(model + 'Model').value
            };

            if (!config.apiKey) {
                showToast('âŒ è¯·è¾“å…¥API Key', true);
                return;
            }

            AppState.apiConfig[model] = config;
            localStorage.setItem(`apiConfig_${model}`, JSON.stringify(config));
            showToast('âœ… é…ç½®å·²ä¿å­˜');
        }

        function loadSavedApiConfigs() {
            const models = ['deepseek', 'doubao', 'kimi', 'tongyi'];

            models.forEach(model => {
                const saved = localStorage.getItem(`apiConfig_${model}`);
                if (saved) {
                    const config = JSON.parse(saved);
                    AppState.apiConfig[model] = config;

                    document.getElementById(model + 'ApiKey').value = config.apiKey || '';
                    document.getElementById(model + 'BaseUrl').value = config.baseUrl || '';
                    document.getElementById(model + 'Model').value = config.model || '';
                }
            });
        }

        async function testApiKey(model) {
            const config = {
                apiKey: document.getElementById(model + 'ApiKey').value,
                baseUrl: document.getElementById(model + 'BaseUrl').value,
                model: document.getElementById(model + 'Model').value
            };

            if (!config.apiKey) {
                showToast('âŒ è¯·å…ˆè¾“å…¥API Key', true);
                return;
            }

            try {
                showLoading(`ğŸ§ª æ­£åœ¨æµ‹è¯•${model}è¿æ¥...`);
                const testPrompt = 'è¯·å›å¤"è¿æ¥æˆåŠŸ"';
                await callAIModel(model, config, testPrompt);

                hideLoading();
                showToast('âœ… è¿æ¥æµ‹è¯•æˆåŠŸï¼');
            } catch (error) {
                hideLoading();
                showToast('âŒ è¿æ¥æµ‹è¯•å¤±è´¥ï¼š' + error.message, true);
            }
        }

        function getApiConfig(model) {
            const config = AppState.apiConfig[model];
            if (!config || !config.apiKey) {
                throw new Error(`è¯·å…ˆé…ç½®${model}çš„APIå¯†é’¥`);
            }
            return config;
        }

        async function callAIModel(model, config, prompt) {
            const commonHeaders = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${config.apiKey}`
            };

            let apiUrl, requestBody;

            switch (model) {
                case 'deepseek':
                    apiUrl = `${config.baseUrl}/chat/completions`;
                    requestBody = {
                        model: config.model,
                        messages: [{ role: 'user', content: prompt }],
                        temperature: 0.7
                    };
                    break;

                case 'doubao':
                    apiUrl = `${config.baseUrl}/chat/completions`;
                    requestBody = {
                        model: config.model,
                        messages: [{ role: 'user', content: prompt }]
                    };
                    break;

                case 'kimi':
                    apiUrl = `${config.baseUrl}/chat/completions`;
                    requestBody = {
                        model: config.model,
                        messages: [{ role: 'user', content: prompt }],
                        temperature: 0.7
                    };
                    break;

                case 'tongyi':
                    apiUrl = `${config.baseUrl}/chat/completions`;
                    requestBody = {
                        model: config.model,
                        messages: [{ role: 'user', content: prompt }]
                    };
                    break;

                default:
                    throw new Error('ä¸æ”¯æŒçš„æ¨¡å‹ï¼š' + model);
            }

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: commonHeaders,
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error?.message || `APIè°ƒç”¨å¤±è´¥: ${response.status}`);
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        // ==================== æ–‡ç« å¤„ç†å‡½æ•° ====================
        async function fetchArticleContent(url) {
            // æ‰©å±•çš„CORSä»£ç†åˆ—è¡¨
            const corsProxies = [
                'https://api.allorigins.win/raw?url=',
                'https://corsproxy.io/?',
                'https://cors-anywhere.herokuapp.com/',
                'https://api.codetabs.com/v1/proxy?quest=',
                'https://thingproxy.freeboard.io/fetch/',
                ''  // ç›´æ¥å°è¯•
            ];

            // é’ˆå¯¹å¸¸è§ç½‘ç«™çš„ä¸“é—¨å¤„ç†
            const siteHandlers = {
                'mp.weixin.qq.com': async () => {
                    throw new Error('å¾®ä¿¡å…¬ä¼—å·æ–‡ç« å—ä¿æŠ¤ï¼Œè¯·å¤åˆ¶æ–‡ç« å†…å®¹åˆ°"æ–‡å­—ç²˜è´´"åŠŸèƒ½');
                },
                'zhihu.com': async () => {
                    throw new Error('çŸ¥ä¹æ–‡ç« éœ€è¦ç™»å½•ï¼Œå»ºè®®å¤åˆ¶å†…å®¹åˆ°"æ–‡å­—ç²˜è´´"åŠŸèƒ½');
                }
            };

            // æ£€æŸ¥æ˜¯å¦æ˜¯éœ€è¦ç‰¹æ®Šå¤„ç†çš„ç½‘ç«™
            try {
                const urlObj = new URL(url);
                const hostname = urlObj.hostname;

                for (const [site, handler] of Object.entries(siteHandlers)) {
                    if (hostname.includes(site)) {
                        await handler();
                        return null;
                    }
                }
            } catch (e) {
                // URLè§£æå¤±è´¥ï¼Œç»§ç»­å°è¯•æŠ“å–
            }

            // å°è¯•å¤šä¸ªä»£ç†å’Œé‡è¯•
            let lastError = null;
            const maxRetries = 2; // æ¯ä¸ªä»£ç†æœ€å¤šé‡è¯•2æ¬¡

            for (const proxy of corsProxies) {
                for (let retry = 0; retry < maxRetries; retry++) {
                    try {
                        console.log(`å°è¯•ä»£ç† ${proxy || 'ç›´æ¥è¿æ¥'} (ç¬¬${retry + 1}æ¬¡)...`);

                        const fetchUrl = proxy
                            ? proxy + encodeURIComponent(url)
                            : url;

                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 15000); // 15ç§’è¶…æ—¶

                        const response = await fetch(fetchUrl, {
                            method: 'GET',
                            headers: {
                                'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
                                'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
                                'Cache-Control': 'no-cache',
                                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                            },
                            signal: controller.signal
                        });

                        clearTimeout(timeoutId);

                        if (response.ok) {
                            const html = await response.text();

                            // æ£€æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆçš„HTMLå†…å®¹
                            if (html.length < 500) {
                                console.log('å†…å®¹è¿‡çŸ­ï¼Œç»§ç»­å°è¯•...');
                                continue;
                            }

                            // æ£€æŸ¥æ˜¯å¦è¢«é‡å®šå‘åˆ°é”™è¯¯é¡µé¢
                            if (html.includes('Access denied') ||
                                html.includes('403 Forbidden') ||
                                html.includes('404 Not Found') ||
                                html.includes('è¯·æ±‚è¢«æ‹’ç»')) {
                                console.log('è®¿é—®è¢«æ‹’ç»ï¼Œå°è¯•ä¸‹ä¸€ä¸ªä»£ç†...');
                                continue;
                            }

                            const content = extractArticleContent(html);
                            if (content && content.length > 300) {
                                console.log('æˆåŠŸæŠ“å–å†…å®¹ï¼é•¿åº¦:', content.length);
                                return content;
                            }
                        } else {
                            console.log(`HTTP ${response.status}: ${response.statusText}`);
                        }
                    } catch (e) {
                        lastError = e;
                        console.log(`é”™è¯¯: ${e.message}ï¼Œä»£ç† ${proxy || 'ç›´æ¥è¿æ¥'} å¤±è´¥`);

                        // å¦‚æœæ˜¯AbortErrorï¼ˆè¶…æ—¶ï¼‰ï¼Œç«‹å³å°è¯•ä¸‹ä¸€ä¸ªä»£ç†
                        if (e.name === 'AbortError') {
                            console.log('è¯·æ±‚è¶…æ—¶ï¼Œå°è¯•ä¸‹ä¸€ä¸ªä»£ç†...');
                            break;
                        }

                        // ç­‰å¾…ä¸€å°æ®µæ—¶é—´åé‡è¯•
                        if (retry < maxRetries - 1) {
                            await new Promise(resolve => setTimeout(resolve, 500));
                        }
                    }
                }
            }

            // å¦‚æœæ‰€æœ‰ä»£ç†éƒ½å¤±è´¥ï¼Œè¿”å›ç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯
            throw new Error(
                'æ— æ³•æŠ“å–è¯¥ç½‘ç«™å†…å®¹ã€‚å»ºè®®ï¼š\n' +
                '1. å¤åˆ¶æ–‡ç« å†…å®¹åˆ°"æ–‡å­—ç²˜è´´"åŠŸèƒ½\n' +
                '2. å°è¯•å…¶ä»–ç½‘ç«™çš„æ–‡ç« é“¾æ¥\n' +
                '3. éƒ¨åˆ†ç½‘ç«™ï¼ˆå¦‚å¾®ä¿¡ã€çŸ¥ä¹ï¼‰æœ‰è®¿é—®é™åˆ¶\n\n' +
                'æŠ€æœ¯åŸå› ï¼š' + (lastError?.message || 'å¯èƒ½å—åˆ°CORSé™åˆ¶æˆ–ç½‘ç«™åçˆ¬è™«æœºåˆ¶')
            );
        }

        function extractArticleContent(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');

            // ç§»é™¤ä¸éœ€è¦çš„æ ‡ç­¾
            const unwantedTags = ['script', 'style', 'nav', 'header', 'footer', 'aside', 'iframe', 'noscript', 'svg', 'link', 'meta'];
            unwantedTags.forEach(tag => {
                doc.querySelectorAll(tag).forEach(el => el.remove());
            });

            // ç§»é™¤å¸¸è§çš„å¹¿å‘Šå’Œæ— å…³å…ƒç´ 
            const unwantedClasses = [
                'ad', 'advertisement', 'banner', 'sidebar', 'comment', 'comments',
                'related', 'recommend', 'share', 'social', 'footer', 'navigation'
            ];
            unwantedClasses.forEach(cls => {
                doc.querySelectorAll(`[class*="${cls}"]`).forEach(el => el.remove());
            });

            // æ‰©å±•çš„æ–‡ç« å†…å®¹é€‰æ‹©å™¨ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
            const articleSelectors = [
                // æ ‡å‡†HTML5æ ‡ç­¾
                'article',
                '[role="article"]',

                // å¸¸è§ä¸­æ–‡ç½‘ç«™
                '.post-content',
                '.article-content',
                '.entry-content',
                '.post-body',
                '.article-body',
                '.content',
                '.article',
                '.post',
                '.main-content',
                '.rich_media_content',  // å¾®ä¿¡å…¬ä¼—å·
                '.show-content',         // çŸ¥ä¹
                '.markdown-body',        // GitHub

                // å¸¸è§è‹±æ–‡ç½‘ç«™
                '[itemprop="articleBody"]',
                '[property="article:body"]',
                '.post-content',
                '.entry-content',
                '.article-body',
                '.content-body',

                // é€šç”¨å®¹å™¨
                'main',
                '#content',
                '#main',
                '.container',
                '.wrapper'
            ];

            // å°è¯•æ‰¾åˆ°æœ€åˆé€‚çš„å†…å®¹å®¹å™¨
            for (const selector of articleSelectors) {
                const elements = doc.querySelectorAll(selector);

                for (const article of elements) {
                    const text = article.textContent
                        .replace(/\s+/g, ' ')
                        .trim();

                    // è¿‡æ»¤æ‰å¤ªçŸ­çš„å†…å®¹ï¼ˆå¯èƒ½æ˜¯å¹¿å‘Šæˆ–å¯¼èˆªï¼‰
                    if (text.length > 300) {
                        // è®¡ç®—æ–‡æœ¬å¯†åº¦ï¼ˆæ–‡æœ¬å­—ç¬¦æ•° / æ€»å­—ç¬¦æ•°ï¼‰
                        const density = text.length / article.innerHTML.length;

                        // å¦‚æœæ–‡æœ¬å¯†åº¦å¤§äº0.15ï¼Œè®¤ä¸ºæ˜¯æœ‰æ•ˆå†…å®¹
                        if (density > 0.15) {
                            console.log(`ä½¿ç”¨é€‰æ‹©å™¨ "${selector}" æ‰¾åˆ°å†…å®¹ï¼Œé•¿åº¦: ${text.length}`);
                            return text.substring(0, 15000); // å¢åŠ åˆ°15000å­—ç¬¦
                        }
                    }
                }
            }

            // å¦‚æœéƒ½æ²¡æ‰¾åˆ°ï¼Œå°è¯•æå–pæ ‡ç­¾
            const paragraphs = doc.querySelectorAll('p');
            if (paragraphs.length > 3) {
                let content = '';
                paragraphs.forEach(p => {
                    const text = p.textContent.trim();
                    if (text.length > 20) {
                        content += text + '\n\n';
                    }
                });

                if (content.length > 300) {
                    console.log('ä»æ®µè½æå–å†…å®¹');
                    return content.trim().substring(0, 15000);
                }
            }

            // æœ€åçš„å¤‡é€‰æ–¹æ¡ˆï¼šè¿”å›bodyæ–‡æœ¬ï¼Œä½†æ¸…ç†æ ¼å¼
            console.log('ä½¿ç”¨bodyæ–‡æœ¬ä½œä¸ºå¤‡é€‰');
            return doc.body.textContent
                .replace(/\s+/g, ' ')
                .trim()
                .substring(0, 15000);
        }

        function detectLanguage(text) {
            const chineseChars = text.match(/[\u4e00-\u9fa5]/g);
            const englishChars = text.match(/[a-zA-Z]/g);

            if (chineseChars && chineseChars.length > 100) {
                return 'zh';
            } else if (englishChars && englishChars.length > 100) {
                return 'en';
            }
            return 'unknown';
        }

        async function translateText(text, from, to) {
            const aiModel = elements.aiModel.value;
            const apiConfig = getApiConfig(aiModel);

            if (aiModel === 'simulate') {
                await simulateDelay(1500);
                return `[ç¿»è¯‘ç»“æœ] ${text.substring(0, 500)}...`;
            }

            try {
                const prompt = `è¯·å°†ä»¥ä¸‹${from === 'en' ? 'è‹±æ–‡' : 'ä¸­æ–‡'}æ–‡æœ¬ç¿»è¯‘æˆ${to === 'en' ? 'è‹±æ–‡' : 'ä¸­æ–‡'}ï¼š\n\n${text.substring(0, 3000)}`;
                const result = await callAIModel(aiModel, apiConfig, prompt);
                return result;
            } catch (error) {
                throw new Error('ç¿»è¯‘å¤±è´¥ï¼š' + error.message);
            }
        }

        async function generateSummary(content) {
            const aiModel = elements.aiModel.value;
            const apiConfig = getApiConfig(aiModel);

            if (aiModel === 'simulate') {
                await simulateDelay(2000);
                return `# æ–‡ç« æ€»ç»“\n\n${content.substring(0, 500)}...`;
            }

            try {
                const prompt = `è¯·å¯¹ä»¥ä¸‹æ–‡ç« å†…å®¹è¿›è¡Œæ€»ç»“ï¼Œè¦æ±‚ï¼š\n1. ä¿ç•™æ‰€æœ‰æ ¸å¿ƒè§‚ç‚¹\n2. ç®€æ´æ˜äº†ï¼Œæ¡ç†æ¸…æ™°\n3. çªå‡ºæ–‡ç« ä»·å€¼\n\næ–‡ç« å†…å®¹ï¼š\n${content.substring(0, 4000)}`;
                const result = await callAIModel(aiModel, apiConfig, prompt);
                return result;
            } catch (error) {
                throw new Error('ç”Ÿæˆæ€»ç»“å¤±è´¥ï¼š' + error.message);
            }
        }

        // ==================== OCRåŠŸèƒ½å®ç° ====================
        let uploadedFiles = [];

        function handleFiles(files) {
            const validFiles = Array.from(files).filter(file => {
                const isValidType = file.type.startsWith('image/') || file.type === 'application/pdf';
                if (!isValidType) {
                    showToast(`âŒ ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${file.name}`, true);
                }
                return isValidType;
            });

            uploadedFiles = [...uploadedFiles, ...validFiles];
            updateFileList();
        }

        function updateFileList() {
            if (uploadedFiles.length === 0) {
                elements.uploadPlaceholder.style.display = 'block';
                elements.fileList.innerHTML = '';
                return;
            }

            elements.uploadPlaceholder.style.display = 'none';
            elements.fileList.innerHTML = uploadedFiles.map((file, index) => {
                const icon = file.type === 'application/pdf' ? 'ğŸ“„' : 'ğŸ–¼ï¸';
                const size = formatFileSize(file.size);

                return `
                    <div class="file-item">
                        <div class="file-item-info">
                            <span class="file-item-icon">${icon}</span>
                            <div>
                                <div class="file-item-name">${file.name}</div>
                                <div class="file-item-size">${size}</div>
                            </div>
                        </div>
                        <button class="file-item-remove" onclick="removeFile(${index})">åˆ é™¤</button>
                    </div>
                `;
            }).join('');
        }

        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            updateFileList();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        async function startOCR() {
            if (uploadedFiles.length === 0) {
                showToast('âŒ è¯·å…ˆä¸Šä¼ å›¾ç‰‡æˆ–PDFæ–‡ä»¶', true);
                return;
            }

            const ocrLanguage = elements.ocrLanguage.value;
            const targetAudience = elements.ocrTargetAudience.value;

            if (!targetAudience) {
                showToast('âŒ è¯·é€‰æ‹©ç›®æ ‡è¯»è€…', true);
                elements.ocrTargetAudience.focus();
                return;
            }

            try {
                elements.ocrProgress.style.display = 'block';
                elements.ocrResult.style.display = 'none';
                elements.startOcrBtn.disabled = true;

                let allText = '';

                for (let i = 0; i < uploadedFiles.length; i++) {
                    const file = uploadedFiles[i];
                    updateProgress(0, `æ­£åœ¨å¤„ç†æ–‡ä»¶ ${i + 1}/${uploadedFiles.length}: ${file.name}`);

                    const text = await processFile(file, ocrLanguage);
                    allText += `\n\n===== ${file.name} =====\n\n${text}`;
                }

                updateProgress(100, 'è¯†åˆ«å®Œæˆï¼');

                elements.ocrOutput.value = allText.trim();
                elements.ocrResult.style.display = 'block';

                const action = elements.ocrAction.value;

                if (action === 'copy') {
                    await navigator.clipboard.writeText(allText);
                    showToast('âœ… è¯†åˆ«ç»“æœå·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                } else if (action === 'paste') {
                    elements.pasteContent.value = allText;
                    switchTab('paste');
                    showToast('âœ… è¯†åˆ«ç»“æœå·²å¤åˆ¶åˆ°æ–‡å­—ç²˜è´´');
                } else if (action === 'rewrite') {
                    await rewriteOCRResult();
                }

            } catch (error) {
                showToast('âŒ è¯†åˆ«å¤±è´¥ï¼š' + error.message, true);
                console.error('OCRé”™è¯¯:', error);
            } finally {
                elements.startOcrBtn.disabled = false;
            }
        }

        async function processFile(file, language) {
            if (file.type === 'application/pdf') {
                return await processPDF(file, language);
            } else {
                return await processImage(file, language);
            }
        }

        async function processImage(file, language) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();

                reader.onload = async (e) => {
                    try {
                        const result = await Tesseract.recognize(
                            e.target.result,
                            language,
                            {
                                logger: m => {
                                    if (m.status === 'recognizing text') {
                                        const progress = Math.round(m.progress * 100);
                                        updateProgress(progress, `æ­£åœ¨è¯†åˆ«æ–‡å­—... ${progress}%`);
                                    }
                                }
                            }
                        );

                        resolve(result.data.text);
                    } catch (error) {
                        reject(error);
                    }
                };

                reader.onerror = () => reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
                reader.readAsDataURL(file);
            });
        }

        async function processPDF(file, language) {
            // ä½¿ç”¨PDF.jså¤„ç†PDFæ–‡ä»¶
            const pdfjsLib = await loadPDFJS();

            return new Promise((resolve, reject) => {
                const reader = new FileReader();

                reader.onload = async (e) => {
                    try {
                        const typedArray = new Uint8Array(e.target.result);
                        const pdf = await pdfjsLib.getDocument(typedArray).promise;

                        let allText = '';

                        for (let i = 1; i <= pdf.numPages; i++) {
                            updateProgress(
                                (i - 1) / pdf.numPages * 100,
                                `æ­£åœ¨å¤„ç†PDFç¬¬ ${i}/${pdf.numPages} é¡µ...`
                            );

                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();

                            const pageText = textContent.items
                                .map(item => item.str)
                                .join(' ');

                            allText += `\n\n--- ç¬¬ ${i} é¡µ ---\n\n${pageText}`;
                        }

                        // å¦‚æœPDFæå–ä¸åˆ°æ–‡å­—ï¼Œå°è¯•è½¬æ¢ä¸ºå›¾ç‰‡è¿›è¡ŒOCR
                        if (allText.trim().length < 50) {
                            showToast('âš ï¸ PDFæ— æ³•ç›´æ¥æå–æ–‡å­—ï¼Œå°†è½¬ä¸ºå›¾ç‰‡è¯†åˆ«', true);
                            const pdfImages = await convertPDFToImages(pdf);
                            let ocrText = '';

                            for (let i = 0; i < pdfImages.length; i++) {
                                updateProgress(
                                    i / pdfImages.length * 100,
                                    `æ­£åœ¨OCRè¯†åˆ«ç¬¬ ${i + 1}/${pdfImages.length} é¡µ...`
                                );

                                const result = await Tesseract.recognize(
                                    pdfImages[i],
                                    language,
                                    {
                                        logger: m => {
                                            if (m.status === 'recognizing text') {
                                                const progress = Math.round(m.progress * 100);
                                                updateProgress(
                                                    i / pdfImages.length * 100 + progress / pdfImages.length,
                                                    `æ­£åœ¨OCRè¯†åˆ«ç¬¬ ${i + 1}/${pdfImages.length} é¡µ... ${progress}%`
                                                );
                                            }
                                        }
                                    }
                                );

                                ocrText += `\n\n--- ç¬¬ ${i + 1} é¡µ ---\n\n${result.data.text}`;
                            }

                            resolve(ocrText);
                        } else {
                            resolve(allText);
                        }
                    } catch (error) {
                        reject(error);
                    }
                };

                reader.onerror = () => reject(new Error('PDFæ–‡ä»¶è¯»å–å¤±è´¥'));
                reader.readAsArrayBuffer(file);
            });
        }

        async function loadPDFJS() {
            if (window.pdfjsLib) {
                return window.pdfjsLib;
            }

            // åŠ¨æ€åŠ è½½PDF.js
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';

            return new Promise((resolve, reject) => {
                script.onload = () => {
                    window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                    resolve(window.pdfjsLib);
                };
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        async function convertPDFToImages(pdf) {
            const images = [];
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale: 2 });

                canvas.width = viewport.width;
                canvas.height = viewport.height;

                await page.render({
                    canvasContext: context,
                    viewport: viewport
                }).promise;

                images.push(canvas.toDataURL('image/png'));
            }

            return images;
        }

        function updateProgress(percent, text) {
            elements.progressFill.style.width = percent + '%';
            elements.progressText.textContent = text;
        }

        function clearOCR() {
            uploadedFiles = [];
            updateFileList();
            elements.ocrOutput.value = '';
            elements.ocrResult.style.display = 'none';
            elements.ocrProgress.style.display = 'none';
            elements.progressFill.style.width = '0%';
            showToast('âœ… å·²æ¸…ç©ºOCRå†…å®¹');
        }

        async function rewriteOCRResult() {
            const ocrText = elements.ocrOutput.value.trim();

            if (!ocrText) {
                showToast('âŒ æ²¡æœ‰å¯æ”¹å†™çš„å†…å®¹', true);
                return;
            }

            const targetAudience = elements.ocrTargetAudience.value;

            if (!targetAudience) {
                showToast('âŒ è¯·é€‰æ‹©ç›®æ ‡è¯»è€…', true);
                elements.ocrTargetAudience.focus();
                return;
            }

            try {
                showLoading('âœï¸ æ­£åœ¨æ™ºèƒ½æ”¹å†™è¯†åˆ«ç»“æœ...');

                const profile = audienceProfiles[targetAudience];
                const aiModel = elements.aiModel.value;
                const apiConfig = getApiConfig(aiModel);

                const prompt = `
ã€åŸå§‹è¯†åˆ«æ–‡å­—ã€‘
${ocrText}

ã€ç›®æ ‡è¯»è€…ã€‘
${profile.name}
- ä½ çš„èº«ä»½ï¼š${profile.role}
- å™äº‹ç»“æ„ï¼š${profile.narrativeStructure}
- æŠ€æœ¯çº¦æŸï¼š${profile.technicalConstraint}
- è¯­è¨€åå¥½ï¼š${profile.characteristics.languagePreference}

ã€æ”¹å†™è¦æ±‚ã€‘
1. å®Œå…¨æŒ‰ç…§ç›®æ ‡è¯»è€…çš„è®¤çŸ¥ç‰¹ç‚¹å’Œè¯­è¨€åå¥½è¿›è¡Œæ”¹å†™
2. ä¿®å¤OCRè¯†åˆ«å¯èƒ½äº§ç”Ÿçš„é”™è¯¯
3. ä¿æŒåŸæ–‡æ ¸å¿ƒè§‚ç‚¹å’Œå…³é”®ä¿¡æ¯
4. ä¸¥æ ¼æŒ‰ç…§æŒ‡å®šçš„å™äº‹ç»“æ„é‡ç»„å†…å®¹
5. ä½¿ç”¨è‡ªç„¶ã€å£è¯­åŒ–çš„è¡¨è¾¾ï¼Œé¿å…AIè…”

ã€è¯­æ°”è¦æ±‚ã€‘
${profile.toneGuidelines.map(g => `- ${g}`).join('\n')}

è¯·å¼€å§‹æ”¹å†™ï¼š
`;

                let result;
                if (aiModel === 'simulate') {
                    await simulateDelay(2000);
                    result = `# æ”¹å†™åçš„å†…å®¹\n\nï¼ˆè¿™æ˜¯æ¨¡æ‹Ÿè¾“å‡ºï¼Œå®é™…ä½¿ç”¨æ—¶ä¼šè°ƒç”¨AIæ¨¡å‹è¿›è¡Œå®Œæ•´æ”¹å†™ï¼‰\n\nåŸå§‹æ–‡å­—é•¿åº¦ï¼š${ocrText.length}å­—`;
                } else {
                    result = await callAIModel(aiModel, apiConfig, prompt);
                }

                // æ˜¾ç¤ºç»“æœ
                elements.articleContent1.textContent = result;
                elements.articleCard1.classList.add('show');
                elements.resultsSection.style.display = 'grid';

                // åˆ‡æ¢åˆ°ç»“æœè§†å›¾
                switchTab('manual');

                hideLoading();
                showToast('âœ… æ”¹å†™å®Œæˆï¼');

            } catch (error) {
                hideLoading();
                showToast('âŒ æ”¹å†™å¤±è´¥ï¼š' + error.message, true);
                console.error('æ”¹å†™é”™è¯¯:', error);
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initEventListeners);
    </script>
</body>
</html>